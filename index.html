<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Top of the Table 1805</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .container {
            max-width: 900px;
            margin: auto;
            padding: 2rem;
        }
        .bg-gray-100 {
            background-color: #f9fafb;
        }
        .btn-primary {
            @apply bg-blue-600 text-white font-bold py-2 px-4 rounded-md shadow-md hover:bg-blue-700 transition duration-300;
        }
        .btn-secondary {
            @apply bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md shadow-md hover:bg-gray-500 transition duration-300;
        }
        .page-link {
            @apply px-4 py-2 rounded-md font-bold transition duration-300;
        }
        .page-link.active {
            @apply bg-blue-600 text-white;
        }
        .page-link:not(.active) {
            @apply text-gray-700 hover:bg-gray-200;
        }
        .chat-window {
            height: 400px;
            overflow-y: scroll;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            display: flex;
            flex-direction: column;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 min-h-screen flex flex-col items-center">

<div id="app" class="container bg-white rounded-xl shadow-lg p-6 lg:p-10 my-8">
    <h1 class="text-4xl font-extrabold text-center text-blue-800 mb-2">Top of the Table 1805</h1>
    
    <!-- Navigation Bar -->
    <nav id="navbar" class="mb-8 flex justify-center gap-4 border-b pb-4 hidden">
        <button id="nav-app" class="page-link active">Picks</button>
        <button id="nav-leaderboard" class="page-link">Leaderboard</button>
        <button id="nav-history" class="page-link">Picks History</button>
        <button id="nav-rules" class="page-link">Rules</button>
    </nav>
    
    <!-- Pages Container -->
    <div id="pages-container">
        <!-- Login Page -->
        <div id="page-login" class="page">
            <div class="p-6">
                <h2 class="text-3xl font-bold text-blue-800 mb-4 text-center">Login</h2>
                <div class="space-y-4">
                    <input type="text" id="loginNameInput" placeholder="Enter your player name" class="w-full p-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="password" id="loginPinInput" placeholder="Enter your PIN" class="w-full p-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="loginBtn" class="btn-primary w-full">Login</button>
                    <p id="loginMessage" class="text-center text-red-500"></p>
                </div>
            </div>
        </div>

        <!-- Main App Page -->
        <div id="page-app" class="page hidden">
            <!-- Player Management Section -->
            <div id="player-manager" class="bg-gray-50 p-6 rounded-lg shadow-inner mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Add Players</h2>
                <div class="flex flex-col sm:flex-row gap-4 mb-4">
                    <input type="text" id="playerNameInput" placeholder="Enter player name" class="flex-grow p-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="password" id="playerPinInput" placeholder="Enter a unique PIN" class="flex-grow p-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="addPlayerBtn" class="btn-primary w-full sm:w-auto">Add Player</button>
                </div>
                <div id="playerList" class="flex flex-wrap gap-2">
                    <!-- Player tags will be injected here by JavaScript -->
                </div>
            </div>

            <!-- Weekly Picks Section -->
            <div id="picks-section" class="bg-gray-50 p-6 rounded-lg shadow-inner mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Make Your Picks</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="playerSelect" class="block text-sm font-medium text-gray-700 mb-1">Select Player</label>
                        <select id="playerSelect" class="w-full p-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="" disabled selected>Choose a player</option>
                        </select>
                    </div>
                    <div>
                        <label for="teamSelect" class="block text-sm font-medium text-gray-700 mb-1">Select Team</label>
                        <select id="teamSelect" class="w-full p-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="" disabled selected>Choose a team</option>
                        </select>
                    </div>
                    <div class="col-span-1 md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Home or Away</label>
                        <div class="flex gap-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="homeAway" value="Home" class="form-radio text-blue-600">
                                <span class="ml-2">Home</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="homeAway" value="Away" class="form-radio text-blue-600">
                                <span class="ml-2">Away</span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end mt-4">
                    <button id="submitPickBtn" class="btn-primary" disabled>Submit Pick</button>
                </div>
                <div id="pickMessage" class="mt-4 text-center text-red-500"></div>
            </div>
        </div>

        <!-- Leaderboard Page -->
        <div id="page-leaderboard" class="page hidden">
            <h2 class="text-3xl font-bold text-blue-800 mb-4">Live Leaderboard</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white rounded-lg shadow">
                    <thead>
                        <tr class="bg-blue-600 text-white uppercase text-sm leading-normal">
                            <th class="py-3 px-6 text-left rounded-tl-lg">Rank</th>
                            <th class="py-3 px-6 text-left">Player</th>
                            <th class="py-3 px-6 text-left rounded-tr-lg">Total Points</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboardTableBody" class="text-gray-600 text-sm font-light">
                        <tr><td colspan="3" class="text-center py-4">No players yet.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Picks History Page -->
        <div id="page-history" class="page hidden">
            <h2 class="text-3xl font-bold text-blue-800 mb-4">Picks History</h2>
            <div id="history-container">
                <!-- Picks history will be injected here by JavaScript -->
            </div>
        </div>

        <!-- Rules Page -->
        <div id="page-rules" class="page hidden">
            <h2 class="text-3xl font-bold text-blue-800 mb-4">League Rules</h2>
            <p class="text-lg text-gray-700 mb-4">You have 40 possible picks for the 38 match weeks. Every team home and away.</p>
            <p class="text-lg text-gray-700 mb-4">3 points for a win, 1 for a draw. If a match is a loss, you get 0 points.</p>
            <p class="text-lg text-gray-700">The leaderboard is automatically tracked and updated once the weekly results are entered by the commissioner.</p>
        </div>
        
        <!-- Admin Page (Hidden by default) -->
        <div id="page-admin" class="page hidden">
            <h2 class="text-3xl font-bold text-blue-800 mb-4">Admin Controls</h2>
            <div class="mb-6 flex justify-between items-center">
                <h3 class="text-xl font-bold">Current Match Week: <span id="current-week-display">1</span></h3>
                <button id="nextWeekBtn" class="btn-primary">Start Next Week</button>
            </div>
            <!-- Game Results Section -->
            <div id="results-section" class="bg-gray-50 p-6 rounded-lg shadow-inner mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Enter Weekly Results</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow">
                        <thead>
                            <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">Team</th>
                                <th class="py-3 px-6 text-left">Result</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody" class="text-gray-600 text-sm font-light">
                            <!-- Teams to be injected here -->
                        </tbody>
                    </table>
                </div>
                <div class="flex justify-end mt-4">
                    <button id="updateScoresBtn" class="btn-primary">Update Scores</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- JavaScript for the Premier League Pick'em App ---
    
    // --- Data Model & Initial State ---
    const TEAMS = [
        "AFC Bournemouth", "Arsenal", "Aston Villa", "Brentford", "Brighton & Hove Albion",
        "Burnley", "Chelsea", "Crystal Palace", "Everton", "Fulham", "Leeds United",
        "Liverpool", "Manchester City", "Manchester United", "Newcastle United",
        "Nottingham Forest", "Sunderland", "Tottenham Hotspur", "West Ham United",
        "Wolverhampton Wanderers"
    ].sort();

    let players = JSON.parse(localStorage.getItem('players')) || [];
    let picks = JSON.parse(localStorage.getItem('picks')) || {};
    let scores = JSON.parse(localStorage.getItem('scores')) || {};
    let currentWeek = JSON.parse(localStorage.getItem('currentWeek')) || 1;
    let loggedInPlayer = null;
    
    const ADMIN_PIN = "1805"; // You can change this to a secure PIN

    // --- DOM Elements ---
    const pages = {
        login: document.getElementById('page-login'),
        app: document.getElementById('page-app'),
        leaderboard: document.getElementById('page-leaderboard'),
        history: document.getElementById('page-history'),
        rules: document.getElementById('page-rules'),
        admin: document.getElementById('page-admin')
    };
    const navbar = document.getElementById('navbar');
    const navLinks = {
        app: document.getElementById('nav-app'),
        leaderboard: document.getElementById('nav-leaderboard'),
        history: document.getElementById('nav-history'),
        rules: document.getElementById('nav-rules')
    };
    const loginNameInput = document.getElementById('loginNameInput');
    const loginPinInput = document.getElementById('loginPinInput');
    const loginBtn = document.getElementById('loginBtn');
    const loginMessage = document.getElementById('loginMessage');
    const playerNameInput = document.getElementById('playerNameInput');
    const playerPinInput = document.getElementById('playerPinInput');
    const addPlayerBtn = document.getElementById('addPlayerBtn');
    const playerList = document.getElementById('playerList');
    const playerSelect = document.getElementById('playerSelect');
    const teamSelect = document.getElementById('teamSelect');
    const submitPickBtn = document.getElementById('submitPickBtn');
    const pickMessage = document.getElementById('pickMessage');
    const resultsTableBody = document.getElementById('resultsTableBody');
    const updateScoresBtn = document.getElementById('updateScoresBtn');
    const leaderboardTableBody = document.getElementById('leaderboardTableBody');
    const historyContainer = document.getElementById('history-container');
    const currentWeekDisplay = document.getElementById('current-week-display');
    const nextWeekBtn = document.getElementById('nextWeekBtn');


    // --- Utility Functions ---

    /**
     * Saves all data to local storage.
     */
    function saveData() {
        localStorage.setItem('players', JSON.stringify(players));
        localStorage.setItem('picks', JSON.stringify(picks));
        localStorage.setItem('scores', JSON.stringify(scores));
        localStorage.setItem('currentWeek', JSON.stringify(currentWeek));
    }

    /**
     * Renders the list of players.
     */
    function renderPlayers() {
        playerList.innerHTML = players.map(player => `
            <span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">
                ${player.name}
            </span>
        `).join('');

        playerSelect.innerHTML = '<option value="" disabled selected>Choose a player</option>';
        players.forEach(player => {
            const option = document.createElement('option');
            option.value = player.name;
            option.textContent = player.name;
            playerSelect.appendChild(option);
        });
    }

    /**
     * Renders the team dropdown for picking.
     */
    function renderTeams() {
        teamSelect.innerHTML = '<option value="" disabled selected>Choose a team</option>';
        TEAMS.forEach(team => {
            const option = document.createElement('option');
            option.value = team;
            option.textContent = team;
            teamSelect.appendChild(option);
        });
    }

    /**
     * Renders the table for entering weekly results.
     */
    function renderResultsTable() {
        const resultsTableBodyElement = document.getElementById('resultsTableBody');
        if (!resultsTableBodyElement) return;

        resultsTableBodyElement.innerHTML = TEAMS.map(team => `
            <tr class="border-b border-gray-200 hover:bg-gray-100">
                <td class="py-3 px-6 text-left whitespace-nowrap font-medium">${team}</td>
                <td class="py-3 px-6 text-left">
                    <select data-team="${team}" class="result-select w-full p-2 rounded-md border border-gray-300">
                        <option value="Pending">Pending</option>
                        <option value="Win">Win</option>
                        <option value="Loss">Loss</option>
                        <option value="Draw">Draw</option>
                    </select>
                </td>
            </tr>
        `).join('');
    }

    /**
     * Renders the leaderboard based on current scores.
     */
    function renderLeaderboard() {
        const sortedScores = Object.entries(scores).sort(([, a], [, b]) => b - a);

        if (sortedScores.length === 0) {
            leaderboardTableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4">No players yet.</td></tr>';
            return;
        }

        leaderboardTableBody.innerHTML = sortedScores.map(([player, score], index) => `
            <tr class="border-b border-gray-200 last:border-b-0 hover:bg-gray-100">
                <td class="py-3 px-6 text-left font-medium">${index + 1}</td>
                <td class="py-3 px-6 text-left">${player}</td>
                <td class="py-3 px-6 text-left font-bold text-blue-600">${score}</td>
            </tr>
        `).join('');
    }

    /**
     * Renders the picks history page.
     */
    function renderPicksHistory() {
        let historyHTML = '';
        const allWeeks = Object.values(picks).flatMap(playerPicks => playerPicks.map(p => p.week));
        const uniqueWeeks = [...new Set(allWeeks)].sort((a, b) => a - b);
        
        if (uniqueWeeks.length === 0) {
            historyContainer.innerHTML = '<p class="text-center text-gray-500">No picks have been made yet.</p>';
            return;
        }

        uniqueWeeks.forEach(week => {
            const weekPicks = {};
            for (const player in picks) {
                const playerWeekPicks = picks[player].filter(p => p.week === week);
                if (playerWeekPicks.length > 0) {
                    weekPicks[player] = playerWeekPicks;
                }
            }

            historyHTML += `
                <div class="bg-gray-50 p-6 rounded-lg shadow-inner mb-6">
                    <h3 class="text-xl font-bold mb-4">Match Week ${week}</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg shadow">
                            <thead>
                                <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                                    <th class="py-3 px-6 text-left">Player</th>
                                    <th class="py-3 px-6 text-left">Team Picked</th>
                                    <th class="py-3 px-6 text-left">Result</th>
                                    <th class="py-3 px-6 text-left">Points</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-600 text-sm font-light">
                                ${Object.entries(weekPicks).map(([player, playerPicks]) =>
                                    playerPicks.map(pick => `
                                        <tr class="border-b border-gray-200 hover:bg-gray-100">
                                            <td class="py-3 px-6 text-left whitespace-nowrap font-medium">${player}</td>
                                            <td class="py-3 px-6 text-left">${pick.team} (${pick.homeAway})</td>
                                            <td class="py-3 px-6 text-left">${pick.result}</td>
                                            <td class="py-3 px-6 text-left">${pick.points}</td>
                                        </tr>
                                    `).join('')
                                ).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        });
        historyContainer.innerHTML = historyHTML;
    }

    /**
     * Checks if a player has already picked a team Home/Away twice.
     */
    function isPickValid(player, team, homeAway) {
        if (!picks[player]) {
            return true;
        }
        
        let homeCount = picks[player].filter(p => p.team === team && p.homeAway === "Home").length;
        let awayCount = picks[player].filter(p => p.team === team && p.homeAway === "Away").length;

        if (homeAway === "Home" && homeCount >= 1) return false;
        if (homeAway === "Away" && awayCount >= 1) return false;

        return true;
    }
    
    /**
     * Handles login and page views.
     */
    function handleLogin() {
        if (loggedInPlayer) {
            navbar.classList.remove('hidden');
            if (loggedInPlayer.name === 'Admin' && loggedInPlayer.pin === ADMIN_PIN) {
                // Admin view
                const adminNavLink = document.createElement('button');
                adminNavLink.id = 'nav-admin';
                adminNavLink.className = 'page-link';
                adminNavLink.textContent = 'Admin';
                if (!document.getElementById('nav-admin')) {
                    navbar.appendChild(adminNavLink);
                    adminNavLink.addEventListener('click', () => {
                         showPage('admin');
                         renderResultsTable();
                         updateCurrentWeekDisplay();
                    });
                }
                showPage('app');
            } else {
                // Regular player view
                showPage('app');
            }
        } else {
            // Not logged in
            showPage('login');
        }
    }

    function updateCurrentWeekDisplay() {
        if (currentWeekDisplay) {
            currentWeekDisplay.textContent = currentWeek;
        }
    }


    // --- Event Listeners ---

    loginBtn.addEventListener('click', () => {
        const name = loginNameInput.value.trim();
        const pin = loginPinInput.value.trim();
        const player = players.find(p => p.name === name);

        if (player && player.pin === pin) {
            loggedInPlayer = player;
            loginMessage.textContent = '';
            handleLogin();
        } else {
            loginMessage.textContent = 'Invalid name or PIN. Please try again.';
        }
    });

    addPlayerBtn.addEventListener('click', () => {
        const name = playerNameInput.value.trim();
        const pin = playerPinInput.value.trim();
        if (name && pin && !players.find(p => p.name === name)) {
            players.push({ name, pin });
            scores[name] = 0;
            picks[name] = [];
            saveData();
            renderPlayers();
            playerNameInput.value = '';
            playerPinInput.value = '';
            renderLeaderboard();
        } else {
            alert('Player already exists or name/PIN is invalid.');
        }
    });

    submitPickBtn.addEventListener('click', () => {
        const player = playerSelect.value;
        const team = teamSelect.value;
        const homeAway = document.querySelector('input[name="homeAway"]:checked')?.value;

        if (!player) {
            alert('Please select a player to submit a pick.');
            return;
        }

        if (isPickValid(player, team, homeAway)) {
            if (!picks[player]) picks[player] = [];
            picks[player].push({ week: currentWeek, team: team, homeAway: homeAway, result: 'Pending', points: 0 });
            saveData();
            pickMessage.textContent = 'Pick submitted successfully!';
            pickMessage.classList.remove('text-red-500');
            pickMessage.classList.add('text-green-600');
            // Clear inputs after submission
            playerSelect.value = '';
            teamSelect.value = '';
            if (document.querySelector('input[name="homeAway"]:checked')) {
                 document.querySelector('input[name="homeAway"]:checked').checked = false;
            }
        } else {
            pickMessage.textContent = `${player} has already picked ${team} for a ${homeAway} game.`;
            pickMessage.classList.remove('text-green-600');
            pickMessage.classList.add('text-red-500');
        }
    });
    
    // Delegated event listener for Update Scores button
    document.addEventListener('click', (e) => {
        if (e.target.id === 'updateScoresBtn') {
            if (loggedInPlayer.name !== 'Admin' || loggedInPlayer.pin !== ADMIN_PIN) {
                alert("You do not have permission to update scores.");
                return;
            }

            // Get results from the table
            const results = {};
            document.querySelectorAll('.result-select').forEach(select => {
                const team = select.dataset.team;
                results[team] = select.value;
            });

            // Update scores for the current week
            for (const player in picks) {
                picks[player].forEach(pick => {
                    if (pick.week === currentWeek) {
                        const gameResult = results[pick.team];
                        if (gameResult === 'Win') {
                            pick.result = 'Win';
                            pick.points = 3;
                        } else if (gameResult === 'Draw') {
                            pick.result = 'Draw';
                            pick.points = 1;
                        } else if (gameResult === 'Loss') {
                            pick.result = 'Loss';
                            pick.points = 0;
                        } else {
                            pick.result = 'Pending';
                            pick.points = 0;
                        }
                    }
                });
            }

            // Recalculate total scores for all players
            for (const player in scores) {
                let totalPoints = 0;
                if (picks[player]) {
                    picks[player].forEach(pick => {
                        totalPoints += pick.points;
                    });
                }
                scores[player] = totalPoints;
            }
            
            saveData();
            renderLeaderboard();
            renderPicksHistory();
            alert(`Scores have been updated for Week ${currentWeek}!`);
        }
    });

    nextWeekBtn.addEventListener('click', () => {
        if (loggedInPlayer.name !== 'Admin' || loggedInPlayer.pin !== ADMIN_PIN) {
            alert("You do not have permission to start a new week.");
            return;
        }
        currentWeek++;
        saveData();
        updateCurrentWeekDisplay();
        alert(`Starting Week ${currentWeek}!`);
    });


    // Update submit button state based on form inputs
    document.querySelectorAll('#picks-section select, #picks-section input').forEach(input => {
        input.addEventListener('change', updateSubmitButtonState);
    });

    function updateSubmitButtonState() {
        const playerSelected = playerSelect.value !== '';
        const teamSelected = teamSelect.value !== '';
        const homeAwaySelected = document.querySelector('input[name="homeAway"]:checked');

        submitPickBtn.disabled = !(playerSelected && teamSelected && homeAwaySelected);
    }

    // --- Page Navigation Logic ---
    function showPage(pageName) {
        Object.values(pages).forEach(page => page.classList.add('hidden'));
        pages[pageName].classList.remove('hidden');

        Object.values(navLinks).forEach(link => link.classList.remove('active'));
        if (navLinks[pageName]) {
            navLinks[pageName].classList.add('active');
        }
    }

    Object.keys(navLinks).forEach(pageName => {
        const link = navLinks[pageName];
        if (link) {
            link.addEventListener('click', () => {
                showPage(pageName);
                if (pageName === 'leaderboard') {
                    renderLeaderboard();
                }
                if (pageName === 'history') {
                    renderPicksHistory();
                }
            });
        }
    });

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        renderPlayers();
        renderTeams();
        renderResultsTable();
        renderLeaderboard();
        updateCurrentWeekDisplay();
        handleLogin();

        // Admin view is shown if URL has admin=true
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('admin') === 'true') {
            // This is for local testing. In a real app, this would be a secure login
            loggedInPlayer = { name: 'Admin', pin: ADMIN_PIN };
            handleLogin();
        }
    });
</script>

</body>
</html>
