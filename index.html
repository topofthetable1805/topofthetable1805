<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premier League Pick'em</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for a cleaner look */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
    </style>
</head>
<body class="p-6 md:p-10">

    <!-- Main Navigation -->
    <nav id="main-nav" class="flex justify-center md:justify-start items-center space-x-4 mb-8"></nav>

    <!-- Main App Container -->
    <div id="app-container" class="bg-white p-6 md:p-8 rounded-xl shadow-lg border border-gray-200">
        <!-- Content will be rendered here by JavaScript -->
        <h1 class="text-3xl font-bold mb-6 text-center">Loading...</h1>
    </div>

    <!-- JavaScript logic -->
    <script>
        // --- Data Initialization and Management ---

        const APP_DATA_KEY = 'pl_pickem_data';
        const TEAMS = [
            "Arsenal", "Aston Villa", "Bournemouth", "Brentford", "Brighton",
            "Chelsea", "Crystal Palace", "Everton", "Fulham", "Ipswich Town",
            "Leicester City", "Liverpool", "Manchester City", "Manchester United",
            "Newcastle United", "Nottingham Forest", "Southampton", "Tottenham Hotspur",
            "West Ham United", "Wolverhampton Wanderers"
        ].sort();

        // Get app data from localStorage or initialize it
        function getAppData() {
            let data = JSON.parse(localStorage.getItem(APP_DATA_KEY));
            if (!data) {
                // Initialize with default values if no data exists
                data = {
                    players: [],
                    picks: {}, // picks[week][playerPin] = { team: 'Team Name', status: 'home' | 'away' }
                    weeklyResults: {}, // weeklyResults[week][team] = 'W' | 'D' | 'L'
                    currentWeek: 1
                };
                localStorage.setItem(APP_DATA_KEY, JSON.stringify(data));
            }
            return data;
        }

        // Save app data to localStorage
        function saveAppData(data) {
            localStorage.setItem(APP_DATA_KEY, JSON.stringify(data));
        }

        // --- Core Application Logic ---

        // Function to render the navigation links
        function renderNav(isAdminPage) {
            const nav = document.getElementById('main-nav');
            nav.innerHTML = `
                <a href="?" class="text-white bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-medium shadow-md transition-colors">Leaderboard</a>
                <a href="?page=history" class="text-white bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-medium shadow-md transition-colors">Picks History</a>
                <a href="?page=rules" class="text-white bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-medium shadow-md transition-colors">Rules</a>
                ${isAdminPage ? `<a href="?admin=true" class="text-white bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg font-medium shadow-md transition-colors">Admin Portal</a>` : ''}
            `;
        }

        // Main function to render the correct page based on URL parameters
        function renderApp() {
            const params = new URLSearchParams(window.location.search);
            const appContainer = document.getElementById('app-container');
            const page = params.get('page');
            const isAdminPage = params.get('admin') === 'true';

            // Render navigation first
            renderNav(isAdminPage);

            // Handle Admin Page
            if (isAdminPage) {
                renderAdminPage(appContainer);
                return;
            }

            // Handle Player Portal
            if (params.get('playerid')) {
                const playerPin = params.get('playerid');
                const data = getAppData();
                const player = data.players.find(p => p.pin === playerPin);
                if (player) {
                    renderPlayerPortal(appContainer, player, data);
                    return;
                } else {
                    appContainer.innerHTML = `<p class="text-red-500 text-center text-xl">Invalid player ID. Please check your link.</p>`;
                    return;
                }
            }

            // Handle Public Pages
            switch (page) {
                case 'history':
                    renderPicksHistoryPage(appContainer);
                    break;
                case 'rules':
                    renderRulesPage(appContainer);
                    break;
                default:
                    renderLeaderboardPage(appContainer);
                    break;
            }
        }

        // --- Page Render Functions ---

        // Renders the Admin Page
        function renderAdminPage(container) {
            const data = getAppData();
            
            let playerListHtml = data.players.length > 0 ?
                `<ul>${data.players.map(p => `
                    <li class="flex items-center justify-between p-2 my-1 bg-gray-100 rounded-lg">
                        <span>${p.name} (PIN: ${p.pin})</span>
                        <button onclick="removePlayer('${p.pin}')" class="text-red-500 hover:text-red-700 font-bold ml-4">Remove</button>
                    </li>`).join('')}</ul>` :
                `<p class="text-gray-500">No players registered yet.</p>`;

            let resultsHtml = TEAMS.map(team => `
                <div class="flex items-center space-x-2">
                    <label class="font-medium">${team}</label>
                    <select id="result-${team.replace(/\s/g, '-')}" class="p-2 border rounded-md shadow-sm flex-grow">
                        <option value="">-- Select Result --</option>
                        <option value="W">Win (W)</option>
                        <option value="D">Draw (D)</option>
                        <option value="L">Loss (L)</option>
                    </select>
                </div>
            `).join('');

            container.innerHTML = `
                <h2 class="text-2xl font-bold mb-4">Admin Portal - Week ${data.currentWeek}</h2>
                <p class="text-sm text-gray-500 mb-6">Note: This page is only accessible via the URL parameter.</p>

                <div class="mb-8">
                    <h3 class="text-xl font-semibold mb-2">Add New Player</h3>
                    <form id="add-player-form" class="flex flex-col md:flex-row gap-4 mb-4">
                        <input type="text" id="playerName" placeholder="Player Name" class="p-2 border rounded-md shadow-sm flex-grow" required>
                        <input type="text" id="playerPin" placeholder="Unique PIN (e.g., 1234)" class="p-2 border rounded-md shadow-sm flex-grow" required>
                        <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-700 transition-colors">Add Player</button>
                    </form>
                    <div class="mt-4">
                        <h3 class="text-xl font-semibold mb-2">Registered Players</h3>
                        ${playerListHtml}
                    </div>
                </div>

                <hr class="my-6 border-gray-300">

                <div class="mb-8">
                    <h3 class="text-xl font-semibold mb-2">Enter Weekly Results (Week ${data.currentWeek})</h3>
                    <div id="results-form-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${resultsHtml}
                    </div>
                </div>

                <div class="flex justify-center">
                    <button onclick="startNextWeek()" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 transition-colors">Start Next Week & Calculate Points</button>
                </div>
            `;

            // Attach event listener for the Add Player form
            document.getElementById('add-player-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const name = document.getElementById('playerName').value.trim();
                const pin = document.getElementById('playerPin').value.trim();
                addPlayer(name, pin);
            });
        }

        // Renders the Player Portal
        function renderPlayerPortal(container, player, data) {
            const currentWeek = data.currentWeek;
            const playerPicks = data.picks[currentWeek] && data.picks[currentWeek][player.pin];
            const isWeekLocked = data.weeklyResults[currentWeek];

            let contentHtml = '';
            if (isWeekLocked) {
                contentHtml = `
                    <p class="text-gray-600 text-lg">Picks for Week ${currentWeek} have been locked by the commissioner.</p>
                    <p class="mt-4 text-center">
                        <a href="?" class="text-white bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-medium shadow-md transition-colors">View Leaderboard</a>
                    </p>
                `;
            } else if (playerPicks) {
                contentHtml = `
                    <p class="text-green-600 text-lg font-semibold">Your pick for Week ${currentWeek} has been saved!</p>
                    <div class="mt-4 p-4 border rounded-lg bg-green-50">
                        <p class="font-medium">Team Picked: <span class="text-gray-800">${playerPicks.team}</span></p>
                        <p class="font-medium">Pick Status: <span class="text-gray-800">${playerPicks.status}</span></p>
                    </div>
                    <p class="mt-4 text-gray-600">The commissioner will enter results soon. You can view the leaderboard or picks history from the main page.</p>
                `;
            } else {
                // Generate team options, excluding teams already picked by the player
                const usedTeams = [...player.homePicksUsed, ...player.awayPicksUsed];
                const teamsOptions = TEAMS.filter(t => !usedTeams.includes(t))
                                                .map(t => `<option value="${t}">${t}</option>`).join('');
                
                contentHtml = `
                    <h3 class="text-xl font-semibold mb-4">Make Your Pick for Week ${currentWeek}</h3>
                    <form id="make-pick-form" class="space-y-4">
                        <div>
                            <label for="team-pick" class="block font-medium mb-1">Select a Team</label>
                            <select id="team-pick" class="w-full p-2 border rounded-md shadow-sm" required>
                                <option value="">-- Select Team --</option>
                                ${teamsOptions}
                            </select>
                        </div>
                        <div>
                            <label class="block font-medium mb-1">Pick Status</label>
                            <div class="flex items-center space-x-4">
                                <label class="inline-flex items-center">
                                    <input type="radio" name="pick-status" value="home" class="form-radio" required>
                                    <span class="ml-2">Home</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="pick-status" value="away" class="form-radio" required>
                                    <span class="ml-2">Away</span>
                                </label>
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-green-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-700 transition-colors">Submit Pick</button>
                    </form>
                `;
            }

            container.innerHTML = `
                <h2 class="text-2xl font-bold mb-4">Welcome, ${player.name}!</h2>
                ${contentHtml}
            `;

            // Attach event listener for the Make Pick form if it exists
            const pickForm = document.getElementById('make-pick-form');
            if (pickForm) {
                pickForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const teamPick = document.getElementById('team-pick').value;
                    const pickStatus = document.querySelector('input[name="pick-status"]:checked').value;
                    
                    savePlayerPick(player.pin, teamPick, pickStatus);
                });
            }
        }

        // Renders the Leaderboard Page
        function renderLeaderboardPage(container) {
            const data = getAppData();
            // Sort players by total points, descending
            const sortedPlayers = [...data.players].sort((a, b) => b.totalPoints - a.totalPoints);
            
            const tableRows = sortedPlayers.length > 0 ?
                sortedPlayers.map((player, index) => `
                    <tr class="${index % 2 === 0 ? 'bg-gray-100' : 'bg-white'}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${index + 1}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${player.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${player.totalPoints}</td>
                    </tr>
                `).join('') :
                `<tr><td colspan="3" class="text-center py-4 text-gray-500">No players on the leaderboard yet.</td></tr>`;

            container.innerHTML = `
                <h2 class="text-2xl font-bold mb-4">Leaderboard</h2>
                <div class="overflow-x-auto shadow-md rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rank</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Player</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Points</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Renders the Picks History Page
        function renderPicksHistoryPage(container) {
            const data = getAppData();
            const picksHtml = [];

            // Iterate through each week
            for (let week = 1; week <= data.currentWeek; week++) {
                // Only show weeks with picks or results
                if (data.picks[week] || data.weeklyResults[week]) {
                    picksHtml.push(`
                        <div class="mb-6 p-4 border rounded-lg shadow-sm">
                            <h3 class="text-xl font-semibold mb-2">Match Week ${week}</h3>
                            <div class="space-y-4">
                    `);
                    
                    const players = data.players;
                    let hasPicksForWeek = false;

                    players.forEach(player => {
                        const playerPick = data.picks[week] ? data.picks[week][player.pin] : null;
                        if (playerPick) {
                            hasPicksForWeek = true;
                            const pickResult = data.weeklyResults[week] ? data.weeklyResults[week][playerPick.team] : null;
                            const pickPoints = pickResult === 'W' ? 3 : pickResult === 'D' ? 1 : 0;

                            picksHtml.push(`
                                <div class="bg-gray-50 p-3 rounded-md">
                                    <p class="font-bold">${player.name}'s Pick:</p>
                                    <p class="ml-4">
                                        Team: ${playerPick.team} 
                                        <span class="font-medium">(${playerPick.status})</span>
                                    </p>
                                    <p class="ml-4">
                                        Result: <span class="font-medium text-${pickResult === 'W' ? 'green' : pickResult === 'D' ? 'yellow' : 'red'}-600">(${pickResult || 'Pending'})</span> -
                                        Points: ${pickResult ? pickPoints : '0'}
                                    </p>
                                </div>
                            `);
                        }
                    });

                    if (!hasPicksForWeek) {
                        picksHtml.push(`<p class="text-gray-500 ml-4">No picks were made this week.</p>`);
                    }

                    picksHtml.push(`</div></div>`);
                }
            }

            container.innerHTML = `
                <h2 class="text-2xl font-bold mb-4">Picks History</h2>
                <div class="space-y-6">
                    ${picksHtml.join('') || '<p class="text-center text-gray-500">No picks have been made yet.</p>'}
                </div>
            `;
        }

        // Renders the Rules Page
        function renderRulesPage(container) {
            container.innerHTML = `
                <h2 class="text-2xl font-bold mb-4">Official Rules</h2>
                <div class="prose max-w-none text-gray-700">
                    <p>Each week, you will make a single pick from any team you have not yet used. The pick can be designated as either a **home** pick or an **away** pick.</p>
                    <p>Over the course of the 38 match weeks, your goal is to have picked each of the 20 Premier League teams once as a home pick and once as an away pick. You have 40 possible picks available.</p>
                    <ul class="list-disc list-inside">
                        <li><strong>3 points</strong> for a Win.</li>
                        <li><strong>1 point</strong> for a Draw.</li>
                        <li><strong>0 points</strong> for a Loss.</li>
                    </ul>
                    <p>The leaderboard is automatically tracked and updated once the weekly results are entered by the commissioner on the Admin Portal.</p>
                </div>
            `;
        }


        // --- Data Manipulation Functions ---

        // Adds a new player to the data
        function addPlayer(name, pin) {
            const data = getAppData();
            if (data.players.find(p => p.pin === pin)) {
                alert("A player with this PIN already exists. Please choose a different one.");
                return;
            }
            data.players.push({
                name: name,
                pin: pin,
                totalPoints: 0,
                homePicksUsed: [],
                awayPicksUsed: []
            });
            saveAppData(data);
            renderApp(); // Re-render the admin page to show the new player
        }

        // Removes a player from the data
        function removePlayer(pin) {
            if (!confirm("Are you sure you want to remove this player? This action cannot be undone.")) {
                return;
            }
            const data = getAppData();
            data.players = data.players.filter(p => p.pin !== pin);
            saveAppData(data);
            renderApp();
        }

        // Saves a player's pick for the current week
        function savePlayerPick(playerPin, teamPick, pickStatus) {
            const data = getAppData();
            const currentWeek = data.currentWeek;
            
            // Initialize picks for the current week if they don't exist
            if (!data.picks[currentWeek]) {
                data.picks[currentWeek] = {};
            }

            // Check if player has already used this team
            const player = data.players.find(p => p.pin === playerPin);
            if (player.homePicksUsed.includes(teamPick) && player.awayPicksUsed.includes(teamPick)) {
                alert(`You have already used ${teamPick} as both a home and away pick.`);
                return;
            }
            if (pickStatus === 'home' && player.homePicksUsed.includes(teamPick)) {
                 alert(`You have already used ${teamPick} as a home pick.`);
                return;
            }
            if (pickStatus === 'away' && player.awayPicksUsed.includes(teamPick)) {
                 alert(`You have already used ${teamPick} as an away pick.`);
                return;
            }
            
            // Save the pick
            data.picks[currentWeek][playerPin] = { team: teamPick, status: pickStatus };

            // Update the player's list of used teams
            if (pickStatus === 'home') {
                player.homePicksUsed.push(teamPick);
            } else {
                player.awayPicksUsed.push(teamPick);
            }
            
            saveAppData(data);
            renderApp(); // Re-render to show success message
        }

        // Calculates points and advances to the next week
        function startNextWeek() {
            const data = getAppData();
            const currentWeek = data.currentWeek;

            // Gather weekly results from the form
            const weeklyResults = {};
            let isResultsComplete = true;
            TEAMS.forEach(team => {
                const selectEl = document.getElementById(`result-${team.replace(/\s/g, '-')}`);
                if (selectEl && selectEl.value) {
                    weeklyResults[team] = selectEl.value;
                } else {
                    isResultsComplete = false;
                }
            });

            if (!isResultsComplete) {
                if (!confirm("Not all team results have been entered. Do you want to proceed anyway? Players with picks for unentered teams will get 0 points.")) {
                    return;
                }
            }

            // Save the results
            data.weeklyResults[currentWeek] = weeklyResults;

            // Calculate points for all players
            data.players.forEach(player => {
                let weekPoints = 0;
                const playerPick = data.picks[currentWeek] ? data.picks[currentWeek][player.pin] : null;

                if (playerPick) {
                    const pickResult = weeklyResults[playerPick.team];
                    if (pickResult === 'W') weekPoints += 3;
                    else if (pickResult === 'D') weekPoints += 1;
                }
                
                // Add to total points
                player.totalPoints += weekPoints;
            });

            // Advance to the next week
            data.currentWeek++;
            saveAppData(data);
            renderApp(); // Re-render the admin page
        }

        // Helper function to get a player's used teams
        function getUsedTeamsForPlayer(playerPin, data) {
            const player = data.players.find(p => p.pin === playerPin);
            return {
                home: player.homePicksUsed,
                away: player.awayPicksUsed
            };
        }

        // Initial render on page load
        window.onload = renderApp;
    </script>

</body>
</html>
