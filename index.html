<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Top of the Table 1805</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for a cleaner look */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
    </style>
    <!-- Firebase SDKs - These are essential for the app to work -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, where, addDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { writeBatch, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


        // Global variables for Firebase services and app state
        window.app = null;
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.isAuthReady = false;
        
        // This is your unique Firebase project config.
        const firebaseConfig = {
          apiKey: "AIzaSyCyt8u-3s0DnxRiqmmuOvDiGAsYza1XepE",
          authDomain: "top-of-the-table-1805.firebaseapp.com",
          databaseURL: "https://top-of-the-table-1805-default-rtdb.firebaseio.com",
          projectId: "top-of-the-table-1805",
          storageBucket: "top-of-the-table-1805.firebasestorage.app",
          messagingSenderId: "293669572169",
          appId: "1:293669572169:web:a4ad447422608b98187998"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        if (firebaseConfig.projectId) {
            try {
                // Initialize Firebase
                window.app = initializeApp(firebaseConfig);
                window.db = getFirestore(window.app);
                window.auth = getAuth(window.app);

                // Handle authentication
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                onAuthStateChanged(window.auth, async (user) => {
                    if (user) {
                        window.userId = user.uid;
                    } else {
                        if (initialAuthToken) {
                            try {
                                await signInWithCustomToken(window.auth, initialAuthToken);
                            } catch (error) {
                                console.error("Error signing in with custom token:", error);
                                await signInAnonymously(window.auth);
                            }
                        } else {
                            await signInAnonymously(window.auth);
                        }
                        window.userId = window.auth.currentUser.uid;
                    }
                    window.isAuthReady = true;
                    // Once authenticated, start the app's rendering logic
                    window.renderApp();
                });
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                document.getElementById('app-container').innerHTML = `
                    <div class="text-center text-red-600">
                        <p class="text-xl font-bold">App Error</p>
                        <p class="mt-2">An error occurred while initializing Firebase. Please check the browser console for details.</p>
                        <p class="mt-2 text-sm text-gray-500">Error: ${e.message}</p>
                    </div>
                `;
            }
        } else {
            console.error("Firebase config is missing. Please set up Firebase.");
            document.getElementById('app-container').innerHTML = `
                <div class="text-center text-red-600">
                    <p class="text-xl font-bold">Firebase Configuration Missing</p>
                    <p class="mt-2">Please provide your Firebase project's configuration to enable data persistence.</p>
                </div>
            `;
        }

        // Expose Firebase and utility functions to the global scope for use in the app's script
        window.getFirestore = getFirestore;
        window.doc = doc;
        window.onSnapshot = onSnapshot;
        window.collection = collection;
        window.query = query;
        window.where = where;
        window.addDoc = addDoc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.writeBatch = writeBatch;
        window.getDocs = getDocs;
        window.getDoc = getDoc;
    </script>

    <!-- Main Navigation -->
    <nav id="main-nav" class="flex justify-center md:justify-start items-center space-x-4 mb-8"></nav>

    <!-- Main App Container -->
    <div id="app-container" class="bg-white p-6 md:p-8 rounded-xl shadow-lg border border-gray-200">
        <!-- Content will be rendered here by JavaScript -->
        <h1 class="text-3xl font-bold mb-6 text-center">Loading...</h1>
    </div>

    <!-- JavaScript logic -->
    <script type="module">
        // --- Data Initialization and Management ---

        const TEAMS = [
            "Arsenal", "Aston Villa", "Bournemouth", "Brentford", "Brighton & Hove Albion",
            "Burnley", "Chelsea", "Crystal Palace", "Everton", "Fulham", "Ipswich Town",
            "Leeds United", "Liverpool", "Manchester City", "Manchester United",
            "Newcastle United", "Nottingham Forest", "Tottenham Hotspur",
            "West Ham United", "Wolverhampton Wanderers"
        ].sort();

        // --- Core Application Logic ---

        // Function to render the navigation links based on the current page
        function renderNav() {
            const nav = document.getElementById('main-nav');
            if (!nav) { // Safety check to ensure the nav element exists
                console.error('Navigation element not found.');
                return;
            }

            const params = new URLSearchParams(window.location.search);
            const isAdminPage = params.get('admin') === 'true';
            
            nav.innerHTML = `
                <a href="?" class="text-white bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-medium shadow-md transition-colors">Leaderboard</a>
                <a href="?page=history" class="text-white bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-medium shadow-md transition-colors">Picks History</a>
                ${isAdminPage ? `<a href="?admin=true" class="text-white bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg font-medium shadow-md transition-colors">Admin Portal</a>` : ''}
            `;
        }

        // Main function to render the correct page based on URL parameters
        window.renderApp = async function() {
            if (!window.isAuthReady) {
                // Wait for auth to be ready before rendering anything
                return;
            }
            
            const params = new URLSearchParams(window.location.search);
            const appContainer = document.getElementById('app-container');
            const page = params.get('page');
            const isAdminPage = params.get('admin') === 'true';

            // Render navigation first
            renderNav();

            // Handle Admin Page
            if (isAdminPage) {
                renderAdminPage(appContainer);
                return;
            }

            // Handle Player Portal
            if (params.get('playerid')) {
                const playerPin = params.get('playerid');
                renderPlayerPortal(appContainer, playerPin);
                return;
            }

            // Handle Public Pages
            switch (page) {
                case 'history':
                    renderPicksHistoryPage(appContainer);
                    break;
                default:
                    renderLeaderboardPage(appContainer);
                    break;
            }
        }

        // --- Page Render Functions ---

        // Renders the Admin Page
        function renderAdminPage(container) {
            // Set up real-time listeners for players and game state
            onSnapshot(doc(window.db, `artifacts/${window.appId}/public/data/game_state`, 'current_state'), (docSnapshot) => {
                const state = docSnapshot.data() || { currentWeek: 1 };
                onSnapshot(collection(window.db, `artifacts/${window.appId}/public/data/players`), (snapshot) => {
                    const players = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    
                    let playerListHtml = players.length > 0 ?
                        `<ul>${players.map(p => `
                            <li class="flex items-center justify-between p-2 my-1 bg-gray-100 rounded-lg">
                                <span>${p.name} (PIN: ${p.pin})</span>
                                <button onclick="window.removePlayer('${p.id}')" class="text-red-500 hover:text-red-700 font-bold ml-4">Remove</button>
                            </li>`).join('')}</ul>` :
                        `<p class="text-gray-500">No players registered yet.</p>`;

                    let resultsHtml = TEAMS.map(team => `
                        <div class="flex items-center space-x-2">
                            <label class="font-medium">${team}</label>
                            <select id="result-${team.replace(/\s/g, '-')}" class="p-2 border rounded-md shadow-sm flex-grow">
                                <option value="">-- Select Result --</option>
                                <option value="W">Win (W)</option>
                                <option value="D">Draw (D)</option>
                                <option value="L">Loss (L)</option>
                            </select>
                        </div>
                    `).join('');

                    container.innerHTML = `
                        <h2 class="text-2xl font-bold mb-4">Admin Portal - Week ${state.currentWeek}</h2>
                        <p class="text-sm text-gray-500 mb-6">Note: This page is only accessible via the URL parameter.</p>

                        <div class="mb-8">
                            <h3 class="text-xl font-semibold mb-2">Add New Player</h3>
                            <form id="add-player-form" class="flex flex-col md:flex-row gap-4 mb-4">
                                <input type="text" id="playerName" placeholder="Player Name" class="p-2 border rounded-md shadow-sm flex-grow" required>
                                <input type="text" id="playerPin" placeholder="Unique PIN (e.g., 1234)" class="p-2 border rounded-md shadow-sm flex-grow" required>
                                <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-700 transition-colors">Add Player</button>
                            </form>
                            <div class="mt-4">
                                <h3 class="text-xl font-semibold mb-2">Registered Players</h3>
                                ${playerListHtml}
                            </div>
                        </div>

                        <hr class="my-6 border-gray-300">

                        <div class="mb-8">
                            <h3 class="text-xl font-semibold mb-2">Enter Weekly Results (Week ${state.currentWeek})</h3>
                            <div id="results-form-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                ${resultsHtml}
                            </div>
                        </div>

                        <div class="flex justify-center">
                            <button onclick="window.startNextWeek()" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 transition-colors">Start Next Week & Calculate Points</button>
                        </div>
                    `;

                    // Attach event listener for the Add Player form
                    const addPlayerForm = document.getElementById('add-player-form');
                    if (addPlayerForm) {
                        addPlayerForm.addEventListener('submit', function(e) {
                            e.preventDefault();
                            const name = document.getElementById('playerName').value.trim();
                            const pin = document.getElementById('playerPin').value.trim();
                            window.addPlayer(name, pin);
                        });
                    }
                });
            });
        }

        // Renders the Player Portal
        function renderPlayerPortal(container, playerPin) {
            let unsubscribePlayer;
            let unsubscribeGameState;
            
            // Set up real-time listener for the player's picks and game state
            unsubscribeGameState = onSnapshot(doc(window.db, `artifacts/${window.appId}/public/data/game_state`, 'current_state'), (stateDoc) => {
                const state = stateDoc.data() || { currentWeek: 1 };
                const currentWeek = state.currentWeek;
                
                onSnapshot(collection(window.db, `artifacts/${window.appId}/public/data/players`), (playersSnapshot) => {
                    const players = playersSnapshot.docs.map(d => d.data());
                    const player = players.find(p => p.pin === playerPin);

                    if (!player) {
                         container.innerHTML = `<p class="text-red-500 text-center text-xl">Invalid player ID. Please check your link.</p>`;
                         return;
                    }
                    
                    onSnapshot(doc(window.db, `artifacts/${window.appId}/public/data/picks`, `week_${currentWeek}`), (picksDoc) => {
                        const weeklyPicks = picksDoc.data() || {};
                        const playerPick = weeklyPicks[player.id];
                        const isWeekLocked = state.weeklyResults && state.weeklyResults[`week_${currentWeek}`];

                        let contentHtml = '';
                        if (isWeekLocked) {
                            contentHtml = `
                                <p class="text-gray-600 text-lg">Picks for Week ${currentWeek} have been locked by the commissioner.</p>
                                <p class="mt-4 text-center">
                                    <a href="?" class="text-white bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-medium shadow-md transition-colors">View Leaderboard</a>
                                </p>
                            `;
                        } else if (playerPick) {
                            contentHtml = `
                                <p class="text-green-600 text-lg font-semibold">Your pick for Week ${currentWeek} has been saved!</p>
                                <div class="mt-4 p-4 border rounded-lg bg-green-50">
                                    <p class="font-medium">Team Picked: <span class="text-gray-800">${playerPick.team}</span></p>
                                    <p class="font-medium">Pick Status: <span class="text-gray-800">${playerPick.status}</span></p>
                                </div>
                                <p class="mt-4 text-gray-600">The commissioner will enter results soon. You can view the leaderboard or picks history from the main page.</p>
                            `;
                        } else {
                            // Generate team options, excluding teams already picked by the player
                            const usedTeams = [...player.homePicksUsed, ...player.awayPicksUsed];
                            const teamsOptions = TEAMS.filter(t => !usedTeams.includes(t))
                                                            .map(t => `<option value="${t}">${t}</option>`).join('');
                            
                            contentHtml = `
                                <h3 class="text-xl font-semibold mb-4">Make Your Pick for Week ${currentWeek}</h3>
                                <form id="make-pick-form" class="space-y-4">
                                    <div>
                                        <label for="team-pick" class="block font-medium mb-1">Select a Team</label>
                                        <select id="team-pick" class="w-full p-2 border rounded-md shadow-sm" required>
                                            <option value="">-- Select Team --</option>
                                            ${teamsOptions}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block font-medium mb-1">Pick Status</label>
                                        <div class="flex items-center space-x-4">
                                            <label class="inline-flex items-center">
                                                <input type="radio" name="pick-status" value="home" class="form-radio" required>
                                                <span class="ml-2">Home</span>
                                            </label>
                                            <label class="inline-flex items-center">
                                                <input type="radio" name="pick-status" value="away" class="form-radio" required>
                                                <span class="ml-2">Away</span>
                                            </label>
                                        </div>
                                    </div>
                                    <button type="submit" class="w-full bg-green-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-700 transition-colors">Submit Pick</button>
                                </form>
                            `;
                        }

                        container.innerHTML = `
                            <h2 class="text-2xl font-bold mb-4">Welcome, ${player.name}!</h2>
                            ${contentHtml}
                        `;

                        // Attach event listener for the Make Pick form if it exists
                        const pickForm = document.getElementById('make-pick-form');
                        if (pickForm) {
                            pickForm.addEventListener('submit', function(e) {
                                e.preventDefault();
                                const teamPick = document.getElementById('team-pick').value;
                                const pickStatus = document.querySelector('input[name="pick-status"]:checked').value;
                                
                                window.savePlayerPick(player.id, player.pin, teamPick, pickStatus);
                            });
                        }
                    });
                });
            });

            // Clean up listeners when leaving the page
            window.addEventListener('beforeunload', () => {
                if (unsubscribePlayer) unsubscribePlayer();
                if (unsubscribeGameState) unsubscribeGameState();
            });
        }

        // Renders the Leaderboard Page
        function renderLeaderboardPage(container) {
            // Set up real-time listener for players
            onSnapshot(collection(window.db, `artifacts/${window.appId}/public/data/players`), (snapshot) => {
                const players = snapshot.docs.map(d => d.data());
                // Sort players by total points, descending
                const sortedPlayers = [...players].sort((a, b) => b.totalPoints - a.totalPoints);
                
                const tableRows = sortedPlayers.length > 0 ?
                    sortedPlayers.map((player, index) => `
                        <tr class="${index % 2 === 0 ? 'bg-gray-100' : 'bg-white'}">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${index + 1}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${player.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${player.totalPoints}</td>
                        </tr>
                    `).join('') :
                    `<tr><td colspan="3" class="text-center py-4 text-gray-500">No players on the leaderboard yet.</td></tr>`;

                container.innerHTML = `
                    <h2 class="text-2xl font-bold mb-4">Leaderboard</h2>
                    <div class="overflow-x-auto shadow-md rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rank</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Player</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Points</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                `;
            });
        }

        // Renders the Picks History Page
        function renderPicksHistoryPage(container) {
             onSnapshot(doc(window.db, `artifacts/${window.appId}/public/data/game_state`, 'current_state'), (stateDoc) => {
                const state = stateDoc.data() || { currentWeek: 1 };
                onSnapshot(collection(window.db, `artifacts/${window.appId}/public/data/players`), (playersSnapshot) => {
                    const players = playersSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    onSnapshot(collection(window.db, `artifacts/${window.appId}/public/data/picks`), (picksSnapshot) => {
                        const allPicks = {};
                        picksSnapshot.forEach(doc => {
                            allPicks[doc.id] = doc.data();
                        });
                        
                        const picksHtml = [];
                        for (let week = 1; week <= state.currentWeek; week++) {
                            const weeklyPicks = allPicks[`week_${week}`];
                            const weeklyResults = state.weeklyResults && state.weeklyResults[`week_${week}`];

                            if (weeklyPicks) {
                                picksHtml.push(`
                                    <div class="mb-6 p-4 border rounded-lg shadow-sm">
                                        <h3 class="text-xl font-semibold mb-2">Match Week ${week}</h3>
                                        <div class="space-y-4">
                                `);
                                
                                let hasPicksForWeek = false;
                                players.forEach(player => {
                                    const playerPick = weeklyPicks[player.id];
                                    if (playerPick) {
                                        hasPicksForWeek = true;
                                        const pickResult = weeklyResults ? weeklyResults[playerPick.team] : null;
                                        const pickPoints = pickResult === 'W' ? 3 : pickResult === 'D' ? 1 : 0;

                                        picksHtml.push(`
                                            <div class="bg-gray-50 p-3 rounded-md">
                                                <p class="font-bold">${player.name}'s Pick:</p>
                                                <p class="ml-4">
                                                    Team: ${playerPick.team} 
                                                    <span class="font-medium">(${playerPick.status})</span>
                                                </p>
                                                <p class="ml-4">
                                                    Result: <span class="font-medium text-${pickResult === 'W' ? 'green' : pickResult === 'D' ? 'yellow' : 'red'}-600">(${pickResult || 'Pending'})</span> -
                                                    Points: ${pickResult ? pickPoints : '0'}
                                                </p>
                                            </div>
                                        `);
                                    }
                                });

                                if (!hasPicksForWeek) {
                                    picksHtml.push(`<p class="text-gray-500 ml-4">No picks were made this week.</p>`);
                                }

                                picksHtml.push(`</div></div>`);
                            }
                        }

                        container.innerHTML = `
                            <h2 class="text-2xl font-bold mb-4">Picks History</h2>
                            <div class="space-y-6">
                                ${picksHtml.join('') || '<p class="text-center text-gray-500">No picks have been made yet.</p>'}
                            </div>
                        `;
                    });
                });
            });
        }


        // --- Data Manipulation Functions ---

        // Adds a new player to the database
        window.addPlayer = async function(name, pin) {
            try {
                const q = query(collection(window.db, `artifacts/${window.appId}/public/data/players`), where("pin", "==", pin));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                     alert("A player with this PIN already exists. Please choose a different one.");
                     return;
                }
                await addDoc(collection(window.db, `artifacts/${window.appId}/public/data/players`), {
                    name: name,
                    pin: pin,
                    totalPoints: 0,
                    homePicksUsed: [],
                    awayPicksUsed: []
                });
            } catch (e) {
                console.error("Error adding player: ", e);
            }
        }

        // Removes a player from the database
        window.removePlayer = async function(playerId) {
            if (!confirm("Are you sure you want to remove this player? This action cannot be undone.")) {
                return;
            }
            try {
                await deleteDoc(doc(window.db, `artifacts/${window.appId}/public/data/players`, playerId));
            } catch (e) {
                console.error("Error removing player: ", e);
            }
        }

        // Saves a player's pick to the database
        window.savePlayerPick = async function(playerId, playerPin, teamPick, pickStatus) {
            try {
                const playerRef = doc(window.db, `artifacts/${window.appId}/public/data/players`, playerId);
                const playerDoc = await getDoc(playerRef);
                const player = playerDoc.data();
                
                if (pickStatus === 'home' && player.homePicksUsed.includes(teamPick)) {
                     alert(`You have already used ${teamPick} as a home pick.`);
                    return;
                }
                if (pickStatus === 'away' && player.awayPicksUsed.includes(teamPick)) {
                     alert(`You have already used ${teamPick} as an away pick.`);
                    return;
                }
                
                const gameStateRef = doc(window.db, `artifacts/${window.appId}/public/data/game_state`, 'current_state');
                const gameStateDoc = await getDoc(gameStateRef);
                const currentWeek = gameStateDoc.data()?.currentWeek || 1;
                const weeklyPicksRef = doc(window.db, `artifacts/${window.appId}/public/data/picks`, `week_${currentWeek}`);
                
                await updateDoc(weeklyPicksRef, {
                    [playerId]: { team: teamPick, status: pickStatus }
                }, { merge: true });

                const newUsedPicks = pickStatus === 'home'
                    ? [...player.homePicksUsed, teamPick]
                    : [...player.awayPicksUsed, teamPick];

                await updateDoc(playerRef, {
                    [`${pickStatus}PicksUsed`]: newUsedPicks
                });

            } catch (e) {
                console.error("Error saving player pick: ", e);
            }
        }

        // Calculates points and advances to the next week
        window.startNextWeek = async function() {
            try {
                const gameStateRef = doc(window.db, `artifacts/${window.appId}/public/data/game_state`, 'current_state');
                const gameStateDoc = await getDoc(gameStateRef);
                const currentWeek = gameStateDoc.data()?.currentWeek || 1;

                // Gather weekly results from the form
                const weeklyResults = {};
                let isResultsComplete = true;
                TEAMS.forEach(team => {
                    const selectEl = document.getElementById(`result-${team.replace(/\s/g, '-')}`);
                    if (selectEl && selectEl.value) {
                        weeklyResults[team] = selectEl.value;
                    } else {
                        isResultsComplete = false;
                    }
                });

                if (!isResultsComplete) {
                    if (!confirm("Not all team results have been entered. Do you want to proceed anyway? Players with picks for unentered teams will get 0 points.")) {
                        return;
                    }
                }
                
                const playersSnapshot = await getDocs(collection(window.db, `artifacts/${window.appId}/public/data/players`));
                const weeklyPicksDoc = await getDoc(doc(window.db, `artifacts/${window.appId}/public/data/picks`, `week_${currentWeek}`));
                const weeklyPicks = weeklyPicksDoc.data() || {};
                
                // Calculate points for all players
                const batch = writeBatch(window.db);
                playersSnapshot.forEach(playerDoc => {
                    const playerRef = playerDoc.ref;
                    const player = playerDoc.data();
                    let weekPoints = 0;
                    const playerPick = weeklyPicks[playerDoc.id];

                    if (playerPick) {
                        const pickResult = weeklyResults[playerPick.team];
                        if (pickResult === 'W') weekPoints += 3;
                        else if (pickResult === 'D') weekPoints += 1;
                    }
                    
                    batch.update(playerRef, {
                        totalPoints: player.totalPoints + weekPoints
                    });
                });

                // Update game state with new week and results
                batch.update(gameStateRef, {
                    currentWeek: currentWeek + 1,
                    weeklyResults: { [`week_${currentWeek}`]: weeklyResults }
                });

                await batch.commit();

            } catch (e) {
                console.error("Error starting next week: ", e);
            }
            }
    </script>
</body>
</html>
