<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Top of the Table 1805</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .container {
            max-width: 900px;
            margin: auto;
            padding: 2rem;
        }
        .bg-gray-100 {
            background-color: #f9fafb;
        }
        .btn-primary {
            @apply bg-blue-600 text-white font-bold py-2 px-4 rounded-md shadow-md hover:bg-blue-700 transition duration-300;
        }
        .btn-secondary {
            @apply bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md shadow-md hover:bg-gray-500 transition duration-300;
        }
        .btn-red {
            @apply bg-red-600 text-white font-bold py-2 px-4 rounded-md shadow-md hover:bg-red-700 transition duration-300;
        }
        .page-link {
            @apply px-4 py-2 rounded-md font-bold transition duration-300;
        }
        .page-link.active {
            @apply bg-blue-600 text-white;
        }
        .page-link:not(.active) {
            @apply text-gray-700 hover:bg-gray-200;
        }
        .chat-window {
            height: 400px;
            overflow-y: scroll;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            display: flex;
            flex-direction: column;
        }
        #recaptcha-container {
            margin-top: 1rem;
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPhoneNumber, RecaptchaVerifier, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, addDoc, serverTimestamp, getDocs, where, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Initialization and Globals ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let userId = null;
        let userName = 'Anonymous';
        let isAdmin = false;
        let confirmationResult;
        
        // --- Admin Configuration ---
        const ADMIN_PHONE_NUMBER = "+18139925685";
        
        // --- Firestore Collections ---
        // Corrected Firestore pathing to fix the "Invalid document reference" error.
        // The path must be `collection/document/collection/document...`
        const publicDataCol = collection(db, 'artifacts', appId, 'public_data');
        const playersRef = collection(publicDataCol, 'players');
        const picksRef = collection(publicDataCol, 'picks');
        const scoresRef = collection(publicDataCol, 'scores');
        const chatRef = collection(publicDataCol, 'chat');
        const gameRef = doc(publicDataCol, 'game_state');
        
        // --- Data Model & Initial State ---
        const TEAMS = [
            "AFC Bournemouth", "Arsenal", "Aston Villa", "Brentford", "Brighton & Hove Albion",
            "Burnley", "Chelsea", "Crystal Palace", "Everton", "Fulham", "Leeds United",
            "Liverpool", "Manchester City", "Manchester United", "Newcastle United",
            "Nottingham Forest", "Sunderland", "Tottenham Hotspur", "West Ham United",
            "Wolverhampton Wanderers"
        ].sort();

        let players = [];
        let scores = {};

        // --- DOM Elements ---
        const pages = {
            login: document.getElementById('page-login'),
            app: document.getElementById('page-app'),
            leaderboard: document.getElementById('page-leaderboard'),
            rules: document.getElementById('page-rules'),
            chat: document.getElementById('page-chat'),
            players: document.getElementById('page-players'),
            admin: document.getElementById('page-admin')
        };
        const navLinks = {
            app: document.getElementById('nav-app'),
            leaderboard: document.getElementById('nav-leaderboard'),
            rules: document.getElementById('nav-rules'),
            chat: document.getElementById('nav-chat'),
            players: document.getElementById('nav-players')
        };

        const loginPhoneNumberInput = document.getElementById('loginPhoneNumberInput');
        const sendCodeBtn = document.getElementById('sendCodeBtn');
        const loginCodeInput = document.getElementById('loginCodeInput');
        const verifyCodeBtn = document.getElementById('verifyCodeBtn');
        const loginMessage = document.getElementById('loginMessage');
        const recaptchaContainer = document.getElementById('recaptcha-container');

        const playerNameInput = document.getElementById('playerNameInput');
        const addPlayerBtn = document.getElementById('addPlayerBtn');
        const playerList = document.getElementById('playerList');
        const playerSelect = document.getElementById('playerSelect');
        const teamSelect = document.getElementById('teamSelect');
        const submitPickBtn = document.getElementById('submitPickBtn');
        const pickMessage = document.getElementById('pickMessage');
        const resultsTableBody = document.getElementById('resultsTableBody');
        const updateScoresBtn = document.getElementById('updateScoresBtn');
        const leaderboardTableBody = document.getElementById('leaderboardTableBody');
        const chatWindow = document.getElementById('chat-window');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const adminPlayerList = document.getElementById('adminPlayerList');

        // --- Utility Functions ---

        function showPage(pageName) {
            Object.values(pages).forEach(page => page.classList.add('hidden'));
            pages[pageName].classList.remove('hidden');

            Object.values(navLinks).forEach(link => link.classList.remove('active'));
            if (navLinks[pageName]) {
                navLinks[pageName].classList.add('active');
            }
        }

        function renderPlayers() {
            playerList.innerHTML = players.map(p => `
                <span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">
                    ${p.name}
                </span>
            `).join('');

            playerSelect.innerHTML = '<option value="" disabled selected>Choose a player</option>';
            players.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = p.name;
                playerSelect.appendChild(option);
            });
        }
        
        function renderAdminPlayerList() {
            adminPlayerList.innerHTML = players.map(p => `
                <div class="flex justify-between items-center bg-white p-3 rounded-lg shadow-sm mb-2">
                    <span class="font-medium">${p.name}</span>
                    <div class="flex gap-2">
                        <button class="btn-secondary text-xs" onclick="makeAdmin('${p.id}', ${p.role === 'admin'})">
                            ${p.role === 'admin' ? 'Revoke Admin' : 'Make Admin'}
                        </button>
                        <button class="btn-red text-xs" onclick="removePlayer('${p.id}')">Remove</button>
                    </div>
                </div>
            `).join('');
        }
        window.removePlayer = async function(playerId) {
            try {
                await deleteDoc(doc(playersRef, playerId));
                const playerPicksQuery = query(picksRef, where('playerId', '==', playerId));
                const playerPicks = await getDocs(playerPicksQuery);
                playerPicks.forEach(async pickDoc => {
                    await deleteDoc(pickDoc.ref);
                });
                await deleteDoc(doc(scoresRef, playerId));
                alert('Player removed successfully.');
            } catch (error) {
                console.error("Error removing player:", error);
                alert('Failed to remove player.');
            }
        };

        window.makeAdmin = async function(playerId, currentlyAdmin) {
            try {
                await setDoc(doc(playersRef, playerId), { role: currentlyAdmin ? 'user' : 'admin' }, { merge: true });
                alert('Player role updated successfully.');
            } catch (error) {
                console.error("Error updating player role:", error);
                alert('Failed to update player role.');
            }
        };

        function renderTeams() {
            teamSelect.innerHTML = '<option value="" disabled selected>Choose a team</option>';
            TEAMS.forEach(team => {
                const option = document.createElement('option');
                option.value = team;
                option.textContent = team;
                teamSelect.appendChild(option);
            });
        }

        function renderResultsTable() {
            resultsTableBody.innerHTML = TEAMS.map(team => `
                <tr class="border-b border-gray-200 hover:bg-gray-100">
                    <td class="py-3 px-6 text-left whitespace-nowrap font-medium">${team}</td>
                    <td class="py-3 px-6 text-left">
                        <select data-team="${team}" class="result-select w-full p-2 rounded-md border border-gray-300">
                            <option value="pending">Pending</option>
                            <option value="win">Win</option>
                            <option value="loss">Loss</option>
                            <option value="draw">Draw</option>
                        </select>
                    </td>
                </tr>
            `).join('');
        }

        function renderLeaderboard() {
            const sortedScores = Object.entries(scores).sort(([, a], [, b]) => b - a);
            if (sortedScores.length === 0) {
                leaderboardTableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4">No players yet.</td></tr>';
                return;
            }

            leaderboardTableBody.innerHTML = sortedScores.map(([id, score], index) => {
                const player = players.find(p => p.id === id);
                const playerName = player ? player.name : 'Unknown Player';
                return `
                    <tr class="border-b border-gray-200 last:border-b-0 hover:bg-gray-100">
                        <td class="py-3 px-6 text-left font-medium">${index + 1}</td>
                        <td class="py-3 px-6 text-left">${playerName}</td>
                        <td class="py-3 px-6 text-left font-bold text-blue-600">${score}</td>
                    </tr>
                `;
            }).join('');
        }

        function updateSubmitButtonState() {
            const playerSelected = playerSelect.value !== '';
            const teamSelected = teamSelect.value !== '';
            const homeAwaySelected = document.querySelector('input[name="homeAway"]:checked');

            submitPickBtn.disabled = !(playerSelected && teamSelected && homeAwaySelected);
        }
        
        function addMessageToChat(author, text, timestamp) {
            const messageDiv = document.createElement('div');
            const formattedTime = new Date(timestamp.toDate()).toLocaleTimeString();
            messageDiv.className = 'mb-2 text-sm';
            messageDiv.innerHTML = `<span class="font-bold text-blue-600">${author} (${formattedTime}):</span> ${text}`;
            chatWindow.appendChild(messageDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // --- Firebase Auth and Data Listeners ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                const userPhoneNumber = user.phoneNumber;
                if (userPhoneNumber === ADMIN_PHONE_NUMBER) {
                    isAdmin = true;
                }

                if (isAdmin) {
                    const adminNavLink = document.createElement('button');
                    adminNavLink.id = 'nav-admin';
                    adminNavLink.className = 'page-link';
                    adminNavLink.textContent = 'Admin';
                    document.querySelector('nav').appendChild(adminNavLink);
                    navLinks.admin = adminNavLink;
                    navLinks.admin.addEventListener('click', () => showPage('admin'));
                }

                showPage(isAdmin ? 'admin' : 'app');
                
                onSnapshot(playersRef, (snapshot) => {
                    players = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderPlayers();
                    if(isAdmin) renderAdminPlayerList();
                });

                onSnapshot(scoresRef, (snapshot) => {
                    scores = {};
                    snapshot.docs.forEach(doc => {
                        scores[doc.id] = doc.data().points;
                    });
                    renderLeaderboard();
                });
                
                onSnapshot(chatRef, (snapshot) => {
                    chatWindow.innerHTML = '';
                    snapshot.docs.forEach(doc => {
                        const message = doc.data();
                        addMessageToChat(message.author, message.text, message.timestamp);
                    });
                });

                const playerDoc = await getDocs(query(playersRef, where('id', '==', userId)));
                if (playerDoc.empty) {
                    await setDoc(doc(playersRef, userId), { 
                        name: `Player_${userId.substring(0, 5)}`,
                        role: 'user',
                        phoneNumber: userPhoneNumber
                    });
                } else {
                    userName = playerDoc.docs[0].data().name;
                }
            } else {
                showPage('login');
            }
        });

        // --- Event Listeners ---
        sendCodeBtn.addEventListener('click', async () => {
            const phoneNumber = loginPhoneNumberInput.value;
            if (phoneNumber) {
                try {
                    window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', { 'size': 'invisible' });
                    confirmationResult = await signInWithPhoneNumber(auth, phoneNumber, window.recaptchaVerifier);
                    loginMessage.textContent = 'Code sent! Enter it below.';
                    sendCodeBtn.classList.add('hidden');
                    loginCodeInput.classList.remove('hidden');
                    verifyCodeBtn.classList.remove('hidden');
                } catch (error) {
                    loginMessage.textContent = 'Failed to send code. Please try again.';
                    console.error("SMS send error:", error);
                }
            }
        });

        verifyCodeBtn.addEventListener('click', async () => {
            const code = loginCodeInput.value;
            if (code) {
                try {
                    await confirmationResult.confirm(code);
                } catch (error) {
                    loginMessage.textContent = 'Invalid code. Please try again.';
                    console.error("Code verification error:", error);
                }
            }
        });
        
        submitPickBtn.addEventListener('click', async () => {
            const player = playerSelect.value;
            const team = teamSelect.value;
            const homeAway = document.querySelector('input[name="homeAway"]:checked')?.value;

            if (!player || !team || !homeAway) {
                pickMessage.textContent = 'Please select a player, team, and home/away status.';
                return;
            }

            const playerPicksQuery = query(picksRef, where('playerId', '==', player), where('team', '==', team), where('homeAway', '==', homeAway));
            const existingPicks = await getDocs(playerPicksQuery);

            if (!existingPicks.empty) {
                pickMessage.textContent = `This player has already picked ${team} for a ${homeAway} game.`;
                return;
            }

            const pickData = {
                playerId: player,
                week: 1,
                team: team,
                homeAway: homeAway,
                result: 'pending'
            };

            await addDoc(picksRef, pickData);
            pickMessage.textContent = 'Pick submitted successfully!';
            playerSelect.value = '';
            teamSelect.value = '';
            document.querySelector('input[name="homeAway"]:checked').checked = false;
            updateSubmitButtonState();
        });

        updateScoresBtn.addEventListener('click', async () => {
            if (!isAdmin) return;
            const results = {};
            document.querySelectorAll('.result-select').forEach(select => {
                results[select.dataset.team] = select.value;
            });
            const allPicksSnapshot = await getDocs(picksRef);
            let updatedScores = {};
            players.forEach(p => updatedScores[p.id] = 0);
            allPicksSnapshot.forEach(pickDoc => {
                const pickData = pickDoc.data();
                const gameResult = results[pickData.team];

                if (gameResult === 'win') {
                    updatedScores[pickData.playerId] += 3;
                } else if (gameResult === 'draw') {
                    updatedScores[pickData.playerId] += 1;
                }
            });
            for (const playerId in updatedScores) {
                await setDoc(doc(scoresRef, playerId), { points: updatedScores[playerId] });
            }
            alert('Scores have been updated!');
        });

        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                sendBtn.click();
            }
        });

        sendBtn.addEventListener('click', async () => {
            const message = chatInput.value.trim();
            if (message) {
                await addDoc(chatRef, {
                    author: userName,
                    text: message,
                    timestamp: serverTimestamp()
                });
                chatInput.value = '';
            }
        });

        document.querySelectorAll('#picks-section select, #picks-section input').forEach(input => {
            input.addEventListener('change', updateSubmitButtonState);
        });

        // --- Page Navigation Logic ---
        Object.keys(navLinks).forEach(pageName => {
            navLinks[pageName].addEventListener('click', () => {
                if (isAdmin && pageName !== 'admin' && navLinks.admin) {
                    navLinks.admin.classList.remove('active');
                } else {
                    Object.values(navLinks).forEach(link => link.classList.remove('active'));
                }
                navLinks[pageName].classList.add('active');
                showPage(pageName);
            });
        });

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            renderTeams();
            renderResultsTable();
            // Initial page is handled by auth state listener
        });
    </script>
</body>
</html>
