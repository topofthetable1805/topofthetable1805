import { useState, useEffect } from 'react';
import { BrowserRouter as Router, Routes, Route, Link } from 'react-router-dom';
import { getAuth, signInWithPhoneNumber, RecaptchaVerifier, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, setDoc, onSnapshot, collection, query, addDoc, serverTimestamp, getDocs, where, deleteDoc } from 'firebase/firestore';
import { initializeApp } from 'firebase/app';

const firebaseConfig = {
  apiKey: "...", // Add your Firebase config here
  authDomain: "...",
  projectId: "...",
  storageBucket: "...",
  messagingSenderId: "...",
  appId: "..."
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const ADMIN_PHONE_NUMBER = "+18139925685";
const TEAMS = [
    "AFC Bournemouth", "Arsenal", "Aston Villa", "Brentford", "Brighton & Hove Albion",
    "Burnley", "Chelsea", "Crystal Palace", "Everton", "Fulham", "Leeds United",
    "Liverpool", "Manchester City", "Manchester United", "Newcastle United",
    "Nottingham Forest", "Sunderland", "Tottenham Hotspur", "West Ham United",
    "Wolverhampton Wanderers"
].sort();

// --- Firestore References ---
const playersRef = collection(db, 'players');
const picksRef = collection(db, 'picks');
const scoresRef = collection(db, 'scores');
const chatRef = collection(db, 'chat');
const gameRef = doc(db, 'game_state', 'state');

// This is the App component that will contain all of your app's logic
export default function App() {
  const [user, setUser] = useState(null);
  const [players, setPlayers] = useState([]);
  const [scores, setScores] = useState({});
  const [isPickerLocked, setIsPickerLocked] = useState(false);
  const [isAdmin, setIsAdmin] = useState(false);

  useEffect(() => {
    onAuthStateChanged(auth, (user) => {
      setUser(user);
      if (user && user.phoneNumber === ADMIN_PHONE_NUMBER) {
        setIsAdmin(true);
      }
    });

    const unsubscribePlayers = onSnapshot(playersRef, (snapshot) => {
      setPlayers(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
    });
    
    const unsubscribeScores = onSnapshot(scoresRef, (snapshot) => {
      const newScores = {};
      snapshot.docs.forEach(doc => {
        newScores[doc.id] = doc.data().points;
      });
      setScores(newScores);
    });

    const unsubscribeGame = onSnapshot(gameRef, (doc) => {
      if (doc.exists()) {
        setIsPickerLocked(doc.data().isLocked);
      }
    });
    
    return () => {
      unsubscribePlayers();
      unsubscribeScores();
      unsubscribeGame();
    };
  }, []);

  return (
    <Router>
      <div className="container mx-auto p-4 lg:p-10 bg-white rounded-xl shadow-lg my-8">
        <h1 className="text-4xl font-extrabold text-center text-blue-800 mb-2">Top of the Table 1805</h1>
        <p className="text-center text-gray-500 mb-8">Your Premier League Pick'em League</p>

        <nav className="mb-8 flex justify-center gap-4 border-b pb-4">
          <NavLink to="/">Picks</NavLink>
          <NavLink to="/leaderboard">Leaderboard</NavLink>
          <NavLink to="/rules">Rules</NavLink>
          {isAdmin && <NavLink to="/admin">Admin</NavLink>}
        </nav>

        <Routes>
          <Route path="/" element={<PicksPage user={user} players={players} isPickerLocked={isPickerLocked} />} />
          <Route path="/leaderboard" element={<LeaderboardPage players={players} scores={scores} />} />
          <Route path="/rules" element={<RulesPage />} />
          {isAdmin && <Route path="/admin" element={<AdminPage players={players} isPickerLocked={isPickerLocked} />} />}
        </Routes>
      </div>
    </Router>
  );
}

// --- Navigation Link Component ---
function NavLink({ to, children }) {
  const [isActive, setIsActive] = useState(false);

  useEffect(() => {
    const path = window.location.pathname;
    setIsActive(path === to);
  }, [to]);

  return (
    <Link
      to={to}
      className={`px-4 py-2 rounded-md font-bold transition duration-300 ${isActive ? 'bg-blue-600 text-white' : 'text-gray-700 hover:bg-gray-200'}`}
    >
      {children}
    </Link>
  );
}

// --- Picks Page ---
function PicksPage({ user, players, isPickerLocked }) {
  const [selectedPlayer, setSelectedPlayer] = useState('');
  const [selectedTeam, setSelectedTeam] = useState('');
  const [homeAway, setHomeAway] = useState('');
  const [message, setMessage] = useState('');

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (isPickerLocked) {
      setMessage('Picks are now locked for this week.');
      return;
    }
    // ... [Logic for pick submission, validation, and Firestore update] ...
    setMessage('Pick submitted successfully!');
  };

  if (!user) {
    return <LoginPage />;
  }

  return (
    <div className="space-y-8">
      <div className="bg-gray-50 p-6 rounded-lg shadow-inner">
        <h2 className="text-2xl font-bold text-gray-800 mb-4">Make Your Picks</h2>
        <form onSubmit={handleSubmit} className="space-y-4">
          <select value={selectedPlayer} onChange={e => setSelectedPlayer(e.target.value)} className="w-full p-3 rounded-md border">
            <option value="">Select a player</option>
            {players.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
          </select>
          <select value={selectedTeam} onChange={e => setSelectedTeam(e.target.value)} className="w-full p-3 rounded-md border">
            <option value="">Select a team</option>
            {TEAMS.map(team => <option key={team} value={team}>{team}</option>)}
          </select>
          <div className="flex gap-4">
            <label className="inline-flex items-center">
              <input type="radio" name="homeAway" value="Home" checked={homeAway === 'Home'} onChange={e => setHomeAway(e.target.value)} className="form-radio text-blue-600" />
              <span className="ml-2">Home</span>
            </label>
            <label className="inline-flex items-center">
              <input type="radio" name="homeAway" value="Away" checked={homeAway === 'Away'} onChange={e => setHomeAway(e.target.value)} className="form-radio text-blue-600" />
              <span className="ml-2">Away</span>
            </label>
          </div>
          <button type="submit" disabled={isPickerLocked} className="btn-primary w-full disabled:bg-gray-400">Submit Pick</button>
        </form>
        {message && <p className="mt-4 text-center text-red-500">{message}</p>}
      </div>
    </div>
  );
}

// --- Leaderboard Page ---
function LeaderboardPage({ players, scores }) {
  const sortedScores = Object.entries(scores).sort(([, a], [, b]) => b - a);

  return (
    <div className="space-y-8">
      <h2 className="text-3xl font-bold text-blue-800 mb-4">Live Leaderboard</h2>
      <div className="overflow-x-auto">
        <table className="min-w-full bg-white rounded-lg shadow">
          <thead>
            <tr className="bg-blue-600 text-white uppercase text-sm leading-normal">
              <th className="py-3 px-6 text-left rounded-tl-lg">Rank</th>
              <th className="py-3 px-6 text-left">Player</th>
              <th className="py-3 px-6 text-left rounded-tr-lg">Total Points</th>
            </tr>
          </thead>
          <tbody className="text-gray-600 text-sm font-light">
            {sortedScores.length === 0 ? (
              <tr><td colSpan="3" className="text-center py-4">No players yet.</td></tr>
            ) : (
              sortedScores.map(([id, score], index) => {
                const player = players.find(p => p.id === id);
                const playerName = player ? player.name : 'Unknown Player';
                return (
                  <tr key={id} className="border-b border-gray-200 last:border-b-0 hover:bg-gray-100">
                    <td className="py-3 px-6 text-left font-medium">{index + 1}</td>
                    <td className="py-3 px-6 text-left">{playerName}</td>
                    <td className="py-3 px-6 text-left font-bold text-blue-600">{score}</td>
                  </tr>
                );
              })
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
}

// --- Rules Page ---
function RulesPage() {
  return (
    <div className="space-y-8">
      <h2 className="text-3xl font-bold text-blue-800 mb-4">League Rules</h2>
      <p className="text-lg text-gray-700">You have 40 possible picks for the 38 match weeks. Every team home and away.</p>
      <p className="text-lg text-gray-700">3 points for a win, 1 for a draw. If a match is a loss, you get 0 points.</p>
      <p className="text-lg text-gray-700">The leaderboard is automatically tracked and updated once the weekly results are entered by the commissioner.</p>
    </div>
  );
}

// --- Admin Page ---
function AdminPage({ players, isPickerLocked }) {
  const handleLockPicks = async () => {
    await setDoc(doc(db, 'game_state', 'state'), { isLocked: !isPickerLocked }, { merge: true });
  };
  
  return (
    <div className="space-y-8">
      <h2 className="text-3xl font-bold text-blue-800 mb-4">Admin Controls</h2>
      <div className="bg-gray-50 p-6 rounded-lg shadow-inner">
        <h3 className="text-2xl font-bold mb-4">Pick Management</h3>
        <p className="mb-4">Current pick status: {isPickerLocked ? 'Locked' : 'Open'}</p>
        <button onClick={handleLockPicks} className={`btn-primary ${isPickerLocked ? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700'}`}>
          {isPickerLocked ? 'Unlock Picks' : 'Lock Picks'}
        </button>
      </div>
      
      <div className="bg-gray-50 p-6 rounded-lg shadow-inner">
        <h3 className="text-2xl font-bold mb-4">Player Management</h3>
        {players.map(player => (
          <div key={player.id} className="flex justify-between items-center p-2 border-b">
            <span>{player.name}</span>
            <div className="space-x-2">
              <button className="btn-secondary">Make Admin</button>
              <button className="btn-red">Remove</button>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

// --- Login Page ---
function LoginPage() {
  const [phoneNumber, setPhoneNumber] = useState('');
  const [code, setCode] = useState('');
  const [message, setMessage] = useState('');
  const [confirmationResult, setConfirmationResult] = useState(null);

  const handleSendCode = async () => {
    try {
      window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', { size: 'invisible' });
      const confirmation = await signInWithPhoneNumber(auth, phoneNumber, window.recaptchaVerifier);
      setConfirmationResult(confirmation);
      setMessage('Code sent! Enter it below.');
    } catch (error) {
      setMessage('Failed to send code. Check your phone number.');
      console.error(error);
    }
  };

  const handleVerifyCode = async () => {
    try {
      await confirmationResult.confirm(code);
    } catch (error) {
      setMessage('Invalid code. Please try again.');
      console.error(error);
    }
  };

  return (
    <div className="max-w-md mx-auto p-6 space-y-4">
      <h2 className="text-3xl font-bold text-blue-800 text-center">Login</h2>
      {!confirmationResult ? (
        <div className="space-y-4">
          <input
            type="tel"
            value={phoneNumber}
            onChange={e => setPhoneNumber(e.target.value)}
            placeholder="E.g., +18139925685"
            className="w-full p-3 rounded-md border"
          />
          <button onClick={handleSendCode} className="btn-primary w-full">Send Code</button>
        </div>
      ) : (
        <div className="space-y-4">
          <input
            type="text"
            value={code}
            onChange={e => setCode(e.target.value)}
            placeholder="Enter verification code"
            className="w-full p-3 rounded-md border"
          />
          <button onClick={handleVerifyCode} className="btn-primary w-full">Verify Code</button>
        </div>
      )}
      {message && <p className="text-center text-red-500 mt-4">{message}</p>}
      <div id="recaptcha-container"></div>
    </div>
  );
}
