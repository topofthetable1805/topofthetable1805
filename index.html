<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Top of the Table 1805</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for a cleaner look */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
    </style>
    <!-- Firebase SDKs - These are essential for the app to work -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
</head>
<body class="p-6 md:p-10">

    <!-- Main Navigation -->
    <nav id="main-nav" class="flex justify-center md:justify-start items-center space-x-4 mb-8"></nav>

    <!-- Main App Container -->
    <div id="app-container" class="bg-white p-6 md:p-8 rounded-xl shadow-lg border border-gray-200">
        <!-- Content will be rendered here by JavaScript -->
        <h1 class="text-3xl font-bold mb-6 text-center">Loading...</h1>
    </div>

    <!-- JavaScript logic -->
    <script>
        // Global state variables
        let gameState = null;
        let players = [];
        let weeklyPicks = {};
        let currentPage = 'leaderboard';
        let currentPlayer = null;

        // --- Firebase Setup ---
        const firebaseConfig = {
            apiKey: "AIzaSyCyt8u-3s0DnxRiqmmuOvDiGAsYza1XepE",
            authDomain: "top-of-the-table-1805.firebaseapp.com",
            databaseURL: "https://top-of-the-table-1805-default-rtdb.firebaseio.com",
            projectId: "top-of-the-table-1805",
            storageBucket: "top-of-the-table-1805.firebasestorage.app",
            messagingSenderId: "293669572169",
            appId: "1:293669572169:web:a4ad447422608b98187998"
        };
        const appId = firebaseConfig.projectId;

        // Make sure the Firebase SDK is loaded before continuing
        window.onload = function() {
            if (typeof firebase === 'undefined') {
                document.getElementById('app-container').innerHTML = `
                    <div class="text-center text-red-600">
                        <p class="text-xl font-bold">Error Loading Firebase</p>
                        <p class="mt-2">The Firebase SDK failed to load. Please check your internet connection.</p>
                    </div>
                `;
                return;
            }

            const app = firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore.getFirestore(app);
            const auth = firebase.auth.getAuth(app);

            firebase.auth.signInAnonymously(auth).then(() => {
                console.log("Signed in anonymously.");
                setupDataListeners(db);
                handleUrlChange();
            }).catch((error) => {
                console.error("Firebase Auth failed:", error);
                document.getElementById('app-container').innerHTML = `
                    <div class="text-center text-red-600">
                        <p class="text-xl font-bold">App Error</p>
                        <p class="mt-2">Authentication failed. Please check the browser console for details.</p>
                    </div>
                `;
            });
        };

        // --- Core Data & App Logic ---
        const TEAMS = [
            "Arsenal", "Aston Villa", "Bournemouth", "Brentford", "Brighton & Hove Albion",
            "Burnley", "Chelsea", "Crystal Palace", "Everton", "Fulham", "Ipswich Town",
            "Leeds United", "Liverpool", "Manchester City", "Manchester United",
            "Newcastle United", "Nottingham Forest", "Tottenham Hotspur",
            "West Ham United", "Wolverhampton Wanderers"
        ].sort();

        function setupDataListeners(db) {
            firebase.firestore.onSnapshot(firebase.firestore.doc(db, `artifacts/${appId}/public/data/game_state`, 'current_state'), (docSnapshot) => {
                gameState = docSnapshot.data() || { currentWeek: 1 };
                renderApp();
            });

            firebase.firestore.onSnapshot(firebase.firestore.collection(db, `artifacts/${appId}/public/data/players`), (snapshot) => {
                players = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                renderApp();
            });
            
            firebase.firestore.onSnapshot(firebase.firestore.collection(db, `artifacts/${appId}/public/data/picks`), (snapshot) => {
                const allPicks = {};
                snapshot.forEach(doc => {
                    allPicks[doc.id] = doc.data();
                });
                weeklyPicks = allPicks;
                renderApp();
            });
        }

        // --- URL & Navigation Handlers ---
        window.onpopstate = () => {
            handleUrlChange();
        };

        function handleUrlChange() {
            const params = new URLSearchParams(window.location.search);
            const playerPin = params.get('playerid');
            const adminMode = params.get('admin') === 'true';

            if (adminMode) {
                currentPage = 'admin';
            } else if (playerPin) {
                currentPage = 'playerPortal';
                currentPlayer = players.find(p => p.pin === playerPin);
            } else if (params.get('page') === 'history') {
                currentPage = 'history';
            } else {
                currentPage = 'leaderboard';
            }
            renderApp();
        }

        function renderNav() {
            const nav = document.getElementById('main-nav');
            if (!nav) {
                console.error('Navigation element not found.');
                return;
            }

            const params = new URLSearchParams(window.location.search);
            const isAdminPage = params.get('admin') === 'true';
            
            nav.innerHTML = `
                <a href="?" class="text-white bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-medium shadow-md transition-colors">Leaderboard</a>
                <a href="?page=history" class="text-white bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-medium shadow-md transition-colors">Picks History</a>
                ${isAdminPage ? `<a href="?admin=true" class="text-white bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg font-medium shadow-md transition-colors">Admin Portal</a>` : ''}
            `;
        }

        function renderApp() {
            if (!gameState || players.length === 0) {
                document.getElementById('app-container').innerHTML = `<h1 class="text-3xl font-bold mb-6 text-center">Loading...</h1>`;
                return;
            }

            renderNav();
            const appContainer = document.getElementById('app-container');

            switch (currentPage) {
                case 'admin':
                    renderAdminPage(appContainer);
                    break;
                case 'playerPortal':
                    renderPlayerPortal(appContainer);
                    break;
                case 'history':
                    renderPicksHistoryPage(appContainer);
                    break;
                default:
                    renderLeaderboardPage(appContainer);
                    break;
            }
        }

        // --- Page Render Functions ---

        function renderAdminPage(container) {
            const currentWeek = gameState.currentWeek || 1;
            const playersList = players;
            
            let playerListHtml = playersList.length > 0 ?
                `<ul>${playersList.map(p => `
                    <li class="flex items-center justify-between p-2 my-1 bg-gray-100 rounded-lg">
                        <span>${p.name} (PIN: ${p.pin})</span>
                        <button onclick="removePlayer('${p.id}')" class="text-red-500 hover:text-red-700 font-bold ml-4">Remove</button>
                    </li>`).join('')}</ul>` :
                `<p class="text-gray-500">No players registered yet.</p>`;

            let resultsHtml = TEAMS.map(team => `
                <div class="flex items-center space-x-2">
                    <label class="font-medium">${team}</label>
                    <select id="result-${team.replace(/\s/g, '-')}" class="p-2 border rounded-md shadow-sm flex-grow">
                        <option value="">-- Select Result --</option>
                        <option value="W">Win (W)</option>
                        <option value="D">Draw (D)</option>
                        <option value="L">Loss (L)</option>
                    </select>
                </div>
            `).join('');

            container.innerHTML = `
                <h2 class="text-2xl font-bold mb-4">Admin Portal - Week ${currentWeek}</h2>
                <p class="text-sm text-gray-500 mb-6">Note: This page is only accessible via the URL parameter.</p>

                <div class="mb-8">
                    <h3 class="text-xl font-semibold mb-2">Add New Player</h3>
                    <form id="add-player-form" class="flex flex-col md:flex-row gap-4 mb-4">
                        <input type="text" id="playerName" name="playerName" placeholder="Player Name" class="p-2 border rounded-md shadow-sm flex-grow" required>
                        <input type="text" id="playerPin" name="playerPin" placeholder="Unique PIN (e.g., 1234)" class="p-2 border rounded-md shadow-sm flex-grow" required>
                        <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-700 transition-colors">Add Player</button>
                    </form>
                    <div class="mt-4">
                        <h3 class="text-xl font-semibold mb-2">Registered Players</h3>
                        ${playerListHtml}
                    </div>
                </div>

                <hr class="my-6 border-gray-300">

                <div class="mb-8">
                    <h3 class="text-xl font-semibold mb-2">Enter Weekly Results (Week ${currentWeek})</h3>
                    <div id="results-form-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${resultsHtml}
                    </div>
                </div>

                <div class="flex justify-center">
                    <button onclick="startNextWeek()" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 transition-colors">Start Next Week & Calculate Points</button>
                </div>
            `;

            document.getElementById('add-player-form').addEventListener('submit', addPlayer);
        }

        function renderPlayerPortal(container) {
            if (!currentPlayer) {
                container.innerHTML = `<p class="text-red-500 text-center text-xl">Invalid player ID. Please check your link.</p>`;
                return;
            }

            const currentWeek = gameState.currentWeek || 1;
            const playerPick = weeklyPicks[`week_${currentWeek}`]?.[currentPlayer.id];
            const isWeekLocked = gameState.weeklyResults && gameState.weeklyResults[`week_${currentWeek}`];
            const usedTeams = [...currentPlayer.homePicksUsed, ...currentPlayer.awayPicksUsed];

            let contentHtml = '';
            if (isWeekLocked) {
                contentHtml = `
                    <p class="text-gray-600 text-lg">Picks for Week ${currentWeek} have been locked by the commissioner.</p>
                `;
            } else if (playerPick) {
                contentHtml = `
                    <p class="text-green-600 text-lg font-semibold">Your pick for Week ${currentWeek} has been saved!</p>
                    <div class="mt-4 p-4 border rounded-lg bg-green-50">
                        <p class="font-medium">Team Picked: <span class="text-gray-800">${playerPick.team}</span></p>
                        <p class="font-medium">Pick Status: <span class="text-gray-800">${playerPick.status}</span></p>
                    </div>
                `;
            } else {
                const teamsOptions = TEAMS.filter(t => !usedTeams.includes(t))
                                                .map(t => `<option value="${t}">${t}</option>`).join('');
                
                contentHtml = `
                    <h3 class="text-xl font-semibold mb-4">Make Your Pick for Week ${currentWeek}</h3>
                    <form id="make-pick-form" class="space-y-4">
                        <div>
                            <label for="team-pick" class="block font-medium mb-1">Select a Team</label>
                            <select id="team-pick" name="teamPick" class="w-full p-2 border rounded-md shadow-sm" required>
                                <option value="">-- Select Team --</option>
                                ${teamsOptions}
                            </select>
                        </div>
                        <div>
                            <label class="block font-medium mb-1">Pick Status</label>
                            <div class="flex items-center space-x-4">
                                <label class="inline-flex items-center">
                                    <input type="radio" name="pickStatus" value="home" class="form-radio" required>
                                    <span class="ml-2">Home</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="pickStatus" value="away" class="form-radio" required>
                                    <span class="ml-2">Away</span>
                                </label>
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-green-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-700 transition-colors">Submit Pick</button>
                    </form>
                `;
            }

            container.innerHTML = `
                <h2 class="text-2xl font-bold mb-4">Welcome, ${currentPlayer.name}!</h2>
                ${contentHtml}
            `;

            if (document.getElementById('make-pick-form')) {
                document.getElementById('make-pick-form').addEventListener('submit', savePlayerPick);
            }
        }

        function renderLeaderboardPage(container) {
            const sortedPlayers = [...players].sort((a, b) => b.totalPoints - a.totalPoints);
            
            const tableRows = sortedPlayers.length > 0 ?
                sortedPlayers.map((player, index) => `
                    <tr class="${index % 2 === 0 ? 'bg-gray-100' : 'bg-white'}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${index + 1}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${player.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${player.totalPoints}</td>
                    </tr>
                `).join('') :
                `<tr><td colspan="3" class="text-center py-4 text-gray-500">No players on the leaderboard yet.</td></tr>`;

            container.innerHTML = `
                <h2 class="text-2xl font-bold mb-4">Leaderboard</h2>
                <div class="overflow-x-auto shadow-md rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rank</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Player</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Points</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderPicksHistoryPage(container) {
            const picksHtml = [];
            for (let week = 1; week < (gameState.currentWeek || 1); week++) {
                const weeklyPicksForWeek = weeklyPicks[`week_${week}`];
                const weeklyResultsForWeek = gameState.weeklyResults && gameState.weeklyResults[`week_${week}`];

                if (weeklyPicksForWeek) {
                    let picksForThisWeek = '';
                    let hasPicksForWeek = false;

                    players.forEach(player => {
                        const playerPick = weeklyPicksForWeek[player.id];
                        if (playerPick) {
                            hasPicksForWeek = true;
                            const pickResult = weeklyResultsForWeek ? weeklyResultsForWeek[playerPick.team] : null;
                            const pickPoints = pickResult === 'W' ? 3 : pickResult === 'D' ? 1 : 0;

                            picksForThisWeek += `
                                <div class="bg-gray-50 p-3 rounded-md">
                                    <p class="font-bold">${player.name}'s Pick:</p>
                                    <p class="ml-4">
                                        Team: ${playerPick.team} 
                                        <span class="font-medium">(${playerPick.status})</span>
                                    </p>
                                    <p class="ml-4">
                                        Result: <span class="font-medium text-${pickResult === 'W' ? 'green' : pickResult === 'D' ? 'yellow' : 'red'}-600">(${pickResult || 'Pending'})</span> -
                                        Points: ${pickResult ? pickPoints : '0'}
                                    </p>
                                </div>
                            `;
                        }
                    });

                    if (!hasPicksForWeek) {
                        picksForThisWeek += `<p class="text-gray-500 ml-4">No picks were made this week.</p>`;
                    }

                    picksHtml.push(`
                        <div class="mb-6 p-4 border rounded-lg shadow-sm">
                            <h3 class="text-xl font-semibold mb-2">Match Week ${week}</h3>
                            <div class="space-y-4">${picksForThisWeek}</div>
                        </div>
                    `);
                }
            }

            container.innerHTML = `
                <h2 class="text-2xl font-bold mb-4">Picks History</h2>
                <div class="space-y-6">
                    ${picksHtml.join('') || '<p class="text-center text-gray-500">No picks have been made yet.</p>'}
                </div>
            `;
        }

        // --- Data Manipulation Functions ---

        async function addPlayer(e) {
            e.preventDefault();
            const name = e.target.playerName.value.trim();
            const pin = e.target.playerPin.value.trim();

            try {
                const q = firebase.firestore.query(firebase.firestore.collection(db, `artifacts/${appId}/public/data/players`), firebase.firestore.where("pin", "==", pin));
                const querySnapshot = await firebase.firestore.getDocs(q);
                if (!querySnapshot.empty) {
                    alert("A player with this PIN already exists. Please choose a different one.");
                    return;
                }
                await firebase.firestore.addDoc(firebase.firestore.collection(db, `artifacts/${appId}/public/data/players`), {
                    name, pin, totalPoints: 0, homePicksUsed: [], awayPicksUsed: []
                });
                e.target.reset();
            } catch (e) {
                console.error("Error adding player: ", e);
                alert("An error occurred while adding the player. Check the console for details.");
            }
        }

        window.removePlayer = async function(playerId) {
            if (!confirm("Are you sure you want to remove this player? This action cannot be undone.")) {
                return;
            }
            try {
                await firebase.firestore.deleteDoc(firebase.firestore.doc(db, `artifacts/${appId}/public/data/players`, playerId));
            } catch (e) {
                console.error("Error removing player: ", e);
                alert("An error occurred while removing the player. Check the console for details.");
            }
        };

        async function savePlayerPick(e) {
            e.preventDefault();
            const teamPick = e.target.teamPick.value;
            const pickStatus = e.target.pickStatus.value;
            
            try {
                const playerRef = firebase.firestore.doc(db, `artifacts/${appId}/public/data/players`, currentPlayer.id);
                const playerDoc = await firebase.firestore.getDoc(playerRef);
                const player = playerDoc.data();
                
                if (pickStatus === 'home' && player.homePicksUsed.includes(teamPick)) {
                    alert(`You have already used ${teamPick} as a home pick.`);
                    return;
                }
                if (pickStatus === 'away' && player.awayPicksUsed.includes(teamPick)) {
                    alert(`You have already used ${teamPick} as an away pick.`);
                    return;
                }
                
                const weeklyPicksRef = firebase.firestore.doc(db, `artifacts/${appId}/public/data/picks`, `week_${gameState.currentWeek}`);
                await firebase.firestore.updateDoc(weeklyPicksRef, {
                    [currentPlayer.id]: { team: teamPick, status: pickStatus }
                }, { merge: true });

                const newUsedPicks = pickStatus === 'home'
                    ? [...player.homePicksUsed, teamPick]
                    : [...player.awayPicksUsed, teamPick];

                await firebase.firestore.updateDoc(playerRef, {
                    [`${pickStatus}PicksUsed`]: newUsedPicks
                });
            } catch (e) {
                console.error("Error saving player pick: ", e);
                alert("An error occurred while submitting your pick. Check the console for details.");
            }
        }

        window.startNextWeek = async function() {
            try {
                const currentWeek = gameState.currentWeek;
                const weeklyResults = {};
                let isResultsComplete = true;
                TEAMS.forEach(team => {
                    const selectEl = document.getElementById(`result-${team.replace(/\s/g, '-')}`);
                    if (selectEl && selectEl.value) {
                        weeklyResults[team] = selectEl.value;
                    } else {
                        isResultsComplete = false;
                    }
                });

                if (!isResultsComplete) {
                    if (!confirm("Not all team results have been entered. Do you want to proceed anyway? Players with picks for unentered teams will get 0 points.")) {
                        return;
                    }
                }
                
                const playersSnapshot = await firebase.firestore.getDocs(firebase.firestore.collection(db, `artifacts/${appId}/public/data/players`));
                const weeklyPicksDoc = await firebase.firestore.getDoc(firebase.firestore.doc(db, `artifacts/${appId}/public/data/picks`, `week_${currentWeek}`));
                const weeklyPicksForWeek = weeklyPicksDoc.data() || {};
                
                const batch = firebase.firestore.writeBatch(db);
                playersSnapshot.docs.forEach(playerDoc => {
                    const playerRef = playerDoc.ref;
                    const player = playerDoc.data();
                    let weekPoints = 0;
                    const playerPick = weeklyPicksForWeek[playerDoc.id];

                    if (playerPick) {
                        const pickResult = weeklyResults[playerPick.team];
                        if (pickResult === 'W') weekPoints += 3;
                        else if (pickResult === 'D') weekPoints += 1;
                    }
                    
                    batch.update(playerRef, {
                        totalPoints: player.totalPoints + weekPoints
                    });
                });

                const gameStateRef = firebase.firestore.doc(db, `artifacts/${appId}/public/data/game_state`, 'current_state');
                batch.update(gameStateRef, {
                    currentWeek: currentWeek + 1,
                    [`weeklyResults.week_${currentWeek}`]: weeklyResults
                });

                await batch.commit();
            } catch (e) {
                console.error("Error starting next week: ", e);
                alert("An error occurred while starting the next week. Check the console for details.");
            }
        };

        // Event listeners for forms (attached after initial render)
        document.addEventListener('submit', (e) => {
            if (e.target && e.target.id === 'add-player-form') {
                addPlayer(e);
            }
            if (e.target && e.target.id === 'make-pick-form') {
                savePlayerPick(e);
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            if (typeof firebase === 'undefined') {
                document.getElementById('app-container').innerHTML = `
                    <div class="text-center text-red-600">
                        <p class="text-xl font-bold">Error Loading Firebase</p>
                        <p class="mt-2">The Firebase SDK failed to load. Please check your internet connection.</p>
                    </div>
                `;
            }
            handleUrlChange();
        });
    </script>
</body>
</html>
